{{ define "main" }}

<div class="annoucenment-bar">
  <strong></strong>‚ö†Ô∏è This tool is a work in progress with an incomplete database. More objects added every day - see progress in the <a href="https://discord.com/channels/1414751279548203008/1414751374394261534">Discord</a>.
</div>

<style>
  .annoucenment-bar {
    background-color:#eeeeee;
    padding: 4px;
    margin: 2px;
  }

  /* Table styling */
  #dayzObjects_wrapper {
    width: 95% !important;
    margin: 20px auto;
    overflow-x: auto;
  }
  #dayzObjects { width: 100% !important; }

  /* Top bar & filters */
  .top-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
  }
  .top-bar select,
  .top-bar input {
    margin-right: 10px;
  }
  #filters {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
    align-items: center;
  }
  #dayzObjects_filter input {
    width: 250px;
    max-width: 100%;
  }
  @media (max-width: 768px) {
    #filters {
      flex-direction: column;
      align-items: stretch;
    }
    #filters label,
    #filters select {
      width: 100%;
    }
    #dayzObjects { font-size: 12px; }
  }
  @media (max-width: 480px) {
    #dayzObjects { font-size: 10px; }
  }

  /* First td as positioning context for buttons */
  #dayzObjects tbody td:first-child {
    position: relative;
  }

  /* Copy buttons */
  .copy-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    cursor: pointer;
    border: none;
    background-color: #656d6d;
    color: #fff;
    font-size: 1em;
    opacity: 0;
    transition: opacity 0.15s ease;
    padding: 2px 4px;
    border-radius: 3px;
  }

  /* Show buttons on hover */
  #dayzObjects tbody td:first-child:hover .copy-btn {
    opacity: 1;
  }

  /* Spacing between the two buttons */
  .copy-btn + .copy-btn {
    right: 40px;
  }

  .copy-btn:hover {
    color: #fff;
  }

  /* Preset toggle button */
  #togglePresets {
    padding: 4px 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
    background-color: #f3f3f3;
    cursor: pointer;
    font-size: 0.9rem;
  }

  #togglePresets.active {
    background-color: #656d6d;
    color: #fff;
    border-color: #656d6d;
  }

  /* Flash row highlight */
  @keyframes flash-highlight {
    0% { background-color: #fff6a1; }
    100% { background-color: transparent; }
  }
  .flash {
    animation: flash-highlight 1s ease-out;
  }
</style>

<div id="filters">
  <label for="filterCategory">Category:</label>
  <select id="filterCategory">
    <option value="">All</option>
  </select>

  <label for="filterConsole">Usable on Console:</label>
  <select id="filterConsole">
    <option value="">All</option>
    <option value="‚úÖ">Yes</option>
    <option value="‚ùå">No</option>
  </select>

  <!-- Show presets toggle -->
  <button id="togglePresets" type="button">Show presets</button>
</div>

<table id="dayzObjects" class="display nowrap" style="width:100%">
  <thead>
    <tr>
      <th>Object name</th>
      <th>In-game name</th>
      <th>Category</th>
      <th>Model Type</th>
      <th>Path</th>
      <th>Console</th>
      <th>Search Tags</th>
    </tr>
  </thead>
  <tbody>
    {{ range .Site.Data.dayz_objects }}
    <tr>
      <td
        data-object="{{ .objectName }}"
        data-p3d="{{ .path }}"
        data-modeltype="{{ .modelType }}"
        data-image="{{ with .image }}{{ . }}{{ end }}"
        data-editorjson='{{ with .editorJson }}{{ . | jsonify }}{{ end }}'
      >
        {{ .objectName }}
        <button class="copy-btn" title="Copy object name">üìã</button>
        <button class="copy-btn editor-copy-btn" title="Copy DayZ Editor JSON">üèóÔ∏è</button>
      </td>
      <td>{{ .inGameName }}</td>
      <td>{{ .category }}</td>
      <td>{{ .modelType }}</td>
      <td>{{ .path }}</td>
      <td>{{ if .usableOnConsole }}‚úÖ{{ else }}‚ùå{{ end }}</td>
      <td>{{ with .searchTags }}{{ . }}{{ end }}</td>
    </tr>
    {{ end }}
  </tbody>
</table>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<script>
$(document).ready(function() {
  var table = $('#dayzObjects').DataTable({
    responsive: true,
    pageLength: 50,
    lengthMenu: [[50,100,200,500],[50,100,200,500]],
    columnDefs: [{ targets: [6], visible: true }],
    dom: '<"top-bar"lfr>tip',
    language: {
      search: "Search: ",
      searchPlaceholder: "'large snow rock', '308 rifles'"
    }
  });

  // Move filters above the DataTables top bar
  $("#filters").insertBefore("#dayzObjects_wrapper .top-bar");

  // Populate Category filter
  var categories = [];
  table.column(2).data().each(function(value) {
    if (value && categories.indexOf(value) === -1) {
      categories.push(value);
    }
  });
  categories.sort().forEach(function(cat) {
    $('#filterCategory').append('<option value="' + cat + '">' + cat + '</option>');
  });

  $('#filterCategory').on('change', function() {
    table.column(2).search(this.value).draw();
  });

  $('#filterConsole').on('change', function() {
    table.column(5).search(this.value).draw();
  });

  // Preset toggle (filters to Editor Preset category)
  // Adjust this string if your category name is slightly different (e.g. "Editor Presets")
  var presetsCategoryValue = "Editor Preset";
  var presetsActive = false;
  var previousCategoryValue = "";

  $('#togglePresets').on('click', function() {
    var $btn = $(this);

    if (!presetsActive) {
      // Activate presets view: remember old category, then switch to Editor Preset
      previousCategoryValue = $('#filterCategory').val();
      $('#filterCategory').val(presetsCategoryValue).trigger('change');
      presetsActive = true;
      $btn.addClass('active').text('Show all');
    } else {
      // Deactivate presets view: restore previous category selection
      $('#filterCategory').val(previousCategoryValue).trigger('change');
      presetsActive = false;
      $btn.removeClass('active').text('Show presets');
    }
  });

  // Hover image preview on first column
  $('#dayzObjects tbody')
    .on('mouseenter', 'td:first-child', function(e) {
      var imgPath = $(this).data('image');
      if (!imgPath) return;

      $('body').append(
        '<div id="imgPreview" style="position:absolute; z-index:9999; border:1px solid #ccc; background:#fff; padding:5px; box-shadow:0 2px 6px rgba(0,0,0,0.2);">' +
          '<img src="/' + imgPath + '" style="max-width:400px; max-height:400px;">' +
        '</div>'
      );
      $('#imgPreview').css({ top: e.pageY + 10, left: e.pageX + 10 });
    })
    .on('mousemove', 'td:first-child', function(e) {
      $('#imgPreview').css({ top: e.pageY + 10, left: e.pageX + 10 });
    })
    .on('mouseleave', 'td:first-child', function() {
      $('#imgPreview').remove();
    });

  // Copy object name (üìã)
  $('#dayzObjects tbody').on('click', '.copy-btn:not(.editor-copy-btn)', function(e) {
    e.stopPropagation();
    var text = $(this).closest('td').data('object');
    navigator.clipboard.writeText(text);
    var $btn = $(this);
    $btn.text('‚úî');
    setTimeout(function() { $btn.text('üìã'); }, 1000);
  });

  // Copy DayZ Editor JSON (üèóÔ∏è) ‚Äì supports presets with multiple objects
  $('#dayzObjects tbody').on('click', '.editor-copy-btn', function(e) {
    e.stopPropagation();
    var $td = $(this).closest('td');

    // 1) Check for predefined editorJson (presets like "TC2 Tower preset")
    var predefined = $td.attr('data-editorjson');
    var jsonText = null;

    if (predefined && predefined.trim() !== "") {
      try {
        var parsed = JSON.parse(predefined); // should be an array
        // Copy as a valid JSON array of separate items
        jsonText = JSON.stringify(parsed, null, 4);

        // If you instead want to paste into an existing array without brackets:
        // jsonText = parsed.map(function(o){ return JSON.stringify(o, null, 4); }).join(',\n');
      } catch (err) {
        console.error("Invalid editorJson for row:", err);
      }
    }

    // 2) Fallback: generate single-object stub (Config / Raw P3D / etc.)
    if (!jsonText) {
      var objName   = $td.data('object');
      var modelType = $td.data('modeltype');
      var path      = $td.data('p3d');

      // Config: use class name; anything else: path + file
      var typeValue = (modelType === "Config")
        ? objName
        : path.replace(/\//g, "\\") + "\\" + objName;

      var json = [{
        Type: typeValue,
        DisplayName: "",
        Position: [0, 0, 0],
        Orientation: [0, 0, 0],
        Scale: 1.0,
        AttachmentMap: {},
        Model: "",
        Flags: 30,
        m_LowBits: 0,
        m_HighBits: 0
      }];

      jsonText = JSON.stringify(json, null, 4);
    }

    // 3) Copy to clipboard
    navigator.clipboard.writeText(jsonText);

    // 4) Button feedback
    var $btn = $(this);
    $btn.text('‚úî');
    setTimeout(function() { $btn.text('üèóÔ∏è'); }, 1000);
  });
});
</script>

{{ end }}
{{ define "head" }}
  {{ partials.Include "head-additions.html" . }}
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
  <style>
    
    #dayzObjects,
    #dayzObjects_wrapper {
      visibility: hidden;
    }
  </style>
{{ end }}

{{ define "main" }}
{{ $objectCount := len .Site.Data.dayz_objects }}

<style>
  .annoucenment-bar {
    background-color: var(--card);
    color: var(--text);
    padding: 6px 8px;
    margin: 2px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-soft);
  }

  
  #dayzObjects_wrapper {
    width: 95% !important;
    margin: 20px auto;
    overflow-x: hidden;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 4px;
    box-shadow: var(--shadow-soft);
    padding: 14px 14px 18px;
  }
  #dayzObjects { width: 100% !important; }

  
  .top-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
  }
  .top-bar select,
  .top-bar input {
    margin-right: 10px;
  }
  #filters {
    display: none;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
    align-items: center;
    padding: 0;
    border-radius: 4px;
    border: none;
    background-color: var(--card);
    box-shadow: none;
  }
  #filters label {
    font-weight: 600;
    color: var(--text);
  }
  .filter-actions {
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }
  .dataTables_length label,
  .dataTables_filter label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: var(--text);
    font-size: 0.95rem;
  }
  .dataTables_length select,
  .dataTables_filter input {
    border-radius: 6px;
  }
  .dataTables_info {
    border: none !important;
  }
  #dayzObjects_filter input {
    width: 250px;
    max-width: 100%;
    background-color: var(--input-bg);
    color: var(--text);
    border: 1px solid var(--input-border);
  }
  @media (max-width: 768px) {
    #filters {
      flex-direction: column;
      align-items: stretch;
    }
    #filters label,
    #filters select {
      width: 100%;
    }
    #dayzObjects { font-size: 11px; }
    #dayzObjects td,
    #dayzObjects th {
      padding: 6px 8px;
    }
  }
  @media (max-width: 480px) {
    #dayzObjects { font-size: 10px; }
    #dayzObjects td,
    #dayzObjects th {
      padding: 5px 6px;
    }
  }

  
  #dayzObjects tbody .object-name-cell {
    position: relative;
    cursor: pointer;
    user-select: none;
  }
  #dayzObjects tbody .path-cell {
    position: relative;
  }
  #dayzObjects tbody tr.object-selected {
    outline: 1px solid var(--accent);
    outline-offset: -1px;
  }

  .copy-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    cursor: pointer;
    border: 1px solid #6b7280;
    background-color: #6b7280;
    color: #fff;
    font-size: 1em;
    opacity: 0;
    transition: opacity 0.15s ease;
    padding: 2px 4px;
    border-radius: 2px;
  }

  
  #dayzObjects tbody .object-name-cell:hover .copy-btn {
    opacity: 1;
  }

  
  .copy-btn.editor-copy-btn {
    right: 40px;
  }
  .copy-btn.pin-btn {
    right: 76px;
  }
  .path-cell .path-pin-btn {
    right: 4px;
    opacity: 0;
  }
  .path-cell:hover .path-pin-btn {
    opacity: 1;
  }

  .copy-btn:hover {
    background-color: #4b5563;
    border-color: #4b5563;
    color: #fff;
  }

  table.dataTable.dtr-inline.collapsed > tbody > tr > td.details-control:before {
    left: 8px;
    right: auto;
  }

  table.dataTable.dtr-inline.collapsed > tbody > tr > td.details-control {
    width: 26px;
    text-align: center;
  }

  table.dataTable tbody tr.child td {
    background: var(--bg-soft);
  }

  
  #togglePresets {
    padding: 8px 12px;
    font-size: 0.95rem;
  }

  #togglePresets.active {
    background-color: var(--accent);
    color: #111;
    border-color: var(--accent);
  }

  
  @keyframes flash-highlight {
    0% { background-color: rgba(242, 183, 0, 0.28); }
    100% { background-color: transparent; }
  }
  .flash {
    animation: flash-highlight 1s ease-out;
  }

  #loadingIndicator {
    margin: 40px 0 8px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-align: center;
    color: var(--text);
  }

  
  #statusMessage {
    margin: 18px 0 0;
    text-align: center;
    font-weight: 500;
    font-style: italic;
    color: var(--muted);
  }

  .objects-layout {
    width: 95%;
    margin: 14px auto 0;
    display: flex;
    gap: 14px;
    align-items: flex-start;
  }

  .objects-layout #dayzObjects_wrapper {
    flex: 1;
    width: auto !important;
    margin: 0;
  }

  .object-focus {
    display: none;
    width: 390px;
    padding: 8px;
    max-width: 100%;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 4px;
    box-shadow: var(--shadow-soft);
    gap: 10px;
    flex-wrap: wrap;
    align-items: flex-start;
    position: sticky;
    top: 12px;
  }
  .object-focus.visible,
  .object-focus.has-pins {
    display: flex;
  }
  .object-focus.collapsed {
    width: 52px;
    padding: 8px 6px;
    justify-content: center;
  }
  .object-focus.collapsed .object-focus__image,
  .object-focus.collapsed .object-focus__details {
    display: none;
  }
  .object-focus__pin-hint {
    display: none;
    margin-top: 6px;
    font-size: 1rem;
    color: var(--muted);
  }
  .object-focus.collapsed .object-focus__pin-hint {
    display: block;
  }

  .object-focus__collapse {
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    border-radius: 6px;
    padding: 6px 8px;
    cursor: pointer;
    font-weight: 700;
    line-height: 1;
  }
  .object-focus__collapse:hover {
    background: var(--bg-soft);
  }
  .object-focus__image {
    width: 100%;
    height: 260px;
    border: none;
    border-radius: 4px;
    background: var(--input-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .object-focus__image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .object-focus__missing {
    color: var(--muted);
    font-style: italic;
    text-align: center;
    padding: 0 10px;
  }
  .object-focus__details {
    flex: 1;
    min-width: 220px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .object-focus__label {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--muted);
  }
  .object-focus__name {
    font-size: clamp(1rem, 0.9rem + 0.5vw, 1.3rem);
    font-weight: 700;
    color: var(--text);
    word-break: break-word;
  }
  .object-focus__path {
    font-family: monospace;
    color: var(--muted);
    font-size: clamp(0.78rem, 0.72rem + 0.3vw, 0.92rem);
    word-break: break-word;
  }
  .object-focus__actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .object-focus__primary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 8px;
  }
  .object-focus__secondary {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .object-focus__secondary.is-right {
    justify-content: flex-end;
  }
  .object-focus__secondary .pill-button {
    font-size: 0.7rem;
    padding: 3px 6px;
  }
  .object-focus__meta {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: clamp(0.78rem, 0.72rem + 0.3vw, 0.92rem);
    color: var(--text);
  }
  .object-focus__meta span {
    color: var(--muted);
  }

  .pinned-objects {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    box-shadow: var(--shadow-soft);
    margin-bottom: 10px;
    width: 100%;
  }

  .pinned-objects.is-empty {
    display: none;
  }

  .pinned-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
  }
  .pinned-copy {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
    align-items: center;
    font-size: 0.85rem;
    color: var(--muted);
  }
  .pinned-copy__row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .pinned-copy .pill-button {
    font-size: 0.7rem;
    padding: 3px 6px;
  }
  .pinned-copy .pill-button.copied {
    background-color: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  .pinned-title {
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    font-size: 0.75rem;
    color: var(--text);
  }

  #pinnedCopyAll {
    display: none;
  }

  #pinnedCopyAll.visible {
    display: inline-flex;
  }

  #pinnedCopyNames {
    display: none;
  }

  #pinnedCopyNames.visible {
    display: inline-flex;
  }
  #pinnedClearAll {
    display: none;
  }
  #pinnedClearAll.visible {
    display: inline-flex;
  }
  #pinnedClearAll {
    margin-left: 6px;
    color: #f87171;
    border-color: #fca5a5;
  }
  #pinnedClearAll:hover {
    color: #ef4444;
    border-color: #ef4444;
  }
  #pinnedDownloadAll {
    display: none;
  }
  #pinnedDownloadAll.visible {
    display: inline-flex;
  }

  .pinned-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .pinned-item {
    display: grid;
    grid-template-columns: 32px 1fr auto;
    align-items: center;
    gap: 6px;
    background: var(--bg-soft);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px 6px;
    cursor: pointer;
    user-select: none;
  }
  .pinned-item:hover {
    background: rgba(148, 163, 184, 0.12);
  }
  .pinned-actions {
    display: inline-flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.15s ease;
  }
  .pinned-item:hover .pinned-actions {
    opacity: 1;
  }
  .pinned-action-btn {
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    border-radius: 4px;
    padding: 2px 4px;
    cursor: pointer;
    font-size: 0.65rem;
  }
  .pinned-action-btn:hover {
    background: var(--bg-soft);
  }

  .pinned-thumb {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: var(--card);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    color: var(--muted);
    font-size: 0.6rem;
  }

  .pinned-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .pinned-name {
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .pinned-remove {
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    border-radius: 6px;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 0.7rem;
  }

  .pinned-remove:hover {
    background: var(--bg-soft);
  }

  .object-focus.focus-empty .object-focus__image,
  .object-focus.focus-empty .object-focus__details {
    display: none;
  }
  .object-focus.empty-state .object-focus__image,
  .object-focus.empty-state .object-focus__actions {
    display: none;
  }
  .object-focus.no-selection .object-focus__actions {
    display: none;
  }
  .object-focus.empty-state .object-focus__details > :not(.object-focus__empty) {
    display: none;
  }
  .object-focus__empty {
    display: none;
    font-size: 0.9rem;
    color: var(--muted);
    text-align: center;
    padding: 16px 8px;
  }
  .object-focus.empty-state .object-focus__empty {
    display: block;
  }

  .object-focus.collapsed .pinned-objects {
    width: 100%;
    padding: 4px;
    border: none;
    box-shadow: none;
    background: transparent;
  }

  .object-focus.collapsed .pinned-header {
    display: none;
  }

  .object-focus.collapsed .pinned-list {
    gap: 6px;
    align-items: center;
  }

  .object-focus.collapsed .pinned-item {
    grid-template-columns: 1fr;
    padding: 0;
    border: none;
    background: transparent;
    cursor: pointer;
    justify-items: center;
  }
  .object-focus.collapsed .pinned-actions {
    display: none;
  }
  .object-focus.collapsed .pinned-thumb {
    width: 36px;
    height: 36px;
  }

  .object-focus.collapsed .pinned-name,
  .object-focus.collapsed .pinned-remove {
    display: none;
  }

  @media (max-width: 1100px) {
    .objects-layout {
      flex-direction: column;
    }
    .object-focus {
      width: 100%;
      position: sticky;
    }
  }
  @media (max-width: 768px) {
    .object-focus__image {
      width: 100%;
      height: 220px;
    }
    .object-focus__details {
      width: 100%;
    }
  }

  #imgPreview img {
    max-width: 400px;
    max-height: 400px;
    display: block;
    border-radius: 3px;
  }
</style>

<div id="filters">
  <label for="filterCategory">Category:</label>
  <select id="filterCategory">
    <option value="">All</option>
  </select>

  <label for="filterConsole">Usable on Console:</label>
  <select id="filterConsole">
    <option value="">All</option>
    <option value="‚úÖ">Yes</option>
    <option value="‚ùå">No</option>
  </select>
  <button id="resetFilters" class="pill-button" type="button">Reset filters</button>

  <div class="filter-actions">
    <button id="togglePresets" class="pill-button" type="button">Show presets</button>
    <button id="themeToggle" class="pill-button theme-toggle" type="button" aria-live="polite">
      Dark mode
    </button>
  </div>
</div>

<div id="loadingIndicator">
  Loading {{ $objectCount }} objects...
</div>

<div id="statusMessage"></div>

<div class="objects-layout">
  <table id="dayzObjects" class="display nowrap" style="width:100%">
    <thead>
      <tr>
        <th></th>
        <th>Class name</th>
        <th>In-game name</th>
        <th>Category</th>
        <th>Path</th>
        <th>Console</th>
        <th>Type</th>
        <th>Search Tags</th>
      </tr>
    </thead>
    <tbody>
      {{ range .Site.Data.dayz_objects }}
      <tr>
        <td class="details-control"></td>
        <td
          class="object-name-cell"
          data-object="{{ .objectName }}"
          data-p3d="{{ .path }}"
          data-modeltype="{{ .modelType }}"
          data-ingame="{{ .inGameName }}"
          data-category="{{ .category }}"
          data-console="{{ if .usableOnConsole }}‚úÖ{{ else }}‚ùå{{ end }}"
          data-tags="{{ with .searchTags }}{{ . }}{{ end }}"
          data-image="{{ with .image }}{{ . }}{{ end }}"
          data-editorjson='{{ with .editorJson }}{{ . | jsonify }}{{ end }}'
        >
          {{ .objectName }}
          <button class="copy-btn pin-btn" title="Pin object">üìå</button>
          <button class="copy-btn" title="Copy object name">üìã</button>
          <button class="copy-btn editor-copy-btn" title="Copy DayZ Editor JSON">üèóÔ∏è</button>
        </td>
        <td>{{ .inGameName }}</td>
        <td>{{ .category }}</td>
        <td class="path-cell">
          {{ .path }}
          {{ if and .path (compare.Ne .path "-") }}
          <button class="copy-btn path-pin-btn" title="Pin path">üìå</button>
          {{ end }}
        </td>
        <td>{{ if .usableOnConsole }}‚úÖ{{ else }}‚ùå{{ end }}</td>
        <td>{{ .modelType }}</td>
        <td>{{ with .searchTags }}{{ . }}{{ end }}</td>
      </tr>
      {{ end }}
    </tbody>
  </table>

  <div id="objectFocus" class="object-focus" aria-live="polite">
    <div class="object-focus__pin-hint" aria-hidden="true">üìå</div>
    <button id="objectFocusCollapse" class="object-focus__collapse" type="button" aria-label="Collapse sidebar">&gt;&gt;</button>
    <div class="object-focus__image" id="objectFocusImage">
      <span class="object-focus__missing">Select an object to preview its image.</span>
    </div>
    <div class="object-focus__details">
      <div id="objectFocusName" class="object-focus__name"></div>
      <div id="objectFocusEmpty" class="object-focus__empty">You can select or pin objects in this menu.</div>
      <div class="object-focus__actions">
        <div class="object-focus__secondary">
          <button id="objectFocusPin" class="pill-button" type="button">üìå Pin</button>
          <button id="objectFocusCopy" class="pill-button" type="button">üîó Copy link</button>
          <button id="objectFocusEditor" class="pill-button" type="button">üèóÔ∏è Copy to Editor</button>
          <button id="objectFocusNameCopy" class="pill-button" type="button">üìã Copy name</button>
        </div>
      </div>
      <div id="objectFocusPath" class="object-focus__path"></div>
      <div class="object-focus__meta" id="objectFocusMeta"></div>
      <div class="object-focus__actions">
        <div class="object-focus__secondary is-right">
          <a id="objectFocusLink" class="pill-button" href="#" download>‚Üì Download image</a>
          <button id="objectFocusClear" class="pill-button" type="button">üÜá Deselect object</button>
        </div>
      </div>
    </div>
    <div id="pinnedObjects" class="pinned-objects is-empty" aria-live="polite">
      <div class="pinned-header">
        <span class="pinned-title">Pinned</span>
        <div class="pinned-copy">
          <div class="pinned-copy__row">
            <span>Copy all:</span>
            <button id="pinnedCopyAll" class="pill-button" type="button" title="Copy all to Editor">üèóÔ∏è</button>
            <button id="pinnedCopyNames" class="pill-button" type="button" title="Copy all names">üìã</button>
          </div>
          <div class="pinned-copy__row">
            <button id="pinnedDownloadAll" class="pill-button" type="button" title="Download all">‚Üì Download all</button>
            <button id="pinnedClearAll" class="pill-button" type="button" title="Unpin all">Unpin all</button>
          </div>
        </div>
      </div>
      <div id="pinnedList" class="pinned-list"></div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
  var statusMessages = [
    'This project is a work in progress - add feedback on the Discord',
	'There are more than 190 hats in DayZ - Sam‚Äôs favourite is the Zimikova',
	'The only P3Ds you can use on console are rocks and plants',
	'Working on console? Filter by console and look for the ‚úÖ mark',
	'You can copy and paste directly into DayZ Editor using the üèóÔ∏è button',
	'DayZ uses the scientific names for plants and animals - but you can just search for "birch" or "wolf"',
	'There are more than 60 different types of birch tree in DayZ',
	'There are more than 40 different types of armbands in DayZ',
	'The most annoying type of object to categorise was railway tracks',
	'There are several invisible ghost assets used for development - they may also be haunted',
	'There are nine types of mushroom in DayZ',
	'There are 31 different playable Survivors in DayZ',
	'You can add size and colour to your searches for large rocks or green bags',
	'Notice an error? Well done, you get a gold star. Report it on the Discord',
	'Sam spent too long categorising fences',
	'If you keep refreshing the page, you will eventually see all these messages',
	'Put your credit card into this website to unlock the object list WITHOUT the errors',
	'There are more than 90 different types of spruce tree in DayZ',
	'There are 45 different houses in DayZ - each has been tagged with its callouts',
	'This loading message hides many sins'
  ];
  (function() {
    var statusMessageEl = document.getElementById('statusMessage');
    if (!statusMessageEl) return;
    statusMessageEl.textContent = statusMessages[Math.floor(Math.random() * statusMessages.length)];
    statusMessageEl.style.display = 'block';
  })();

  $(document).ready(function() {
    var statusMessageEl = document.getElementById('statusMessage');
    var $tableEl = $('#dayzObjects');
    $('#filters').hide();

    var showContent = function() {
      $('#dayzObjects, #dayzObjects_wrapper').css('visibility', 'visible');
      $('#loadingIndicator').hide();
      $('#filters').css('display', 'flex');
      if (statusMessageEl) {
        statusMessageEl.style.display = 'none';
      }
    };
    
    $tableEl.one('init.dt', showContent);

    var table = $tableEl.DataTable({
      responsive: {
        details: {
          type: 'column',
          target: 0
        }
      },
      pageLength: 50,
      lengthMenu: [[50,100,200,500],[50,100,200,500]],
      columnDefs: [
        { targets: [7], visible: false },
        { targets: 0, orderable: false, className: 'dtr-control' }
      ],
      dom: '<"top-bar"lfr>tip',
      language: {
        search: "Search: ",
        searchPlaceholder: "'large snow rock', '308 rifles'"
      }
    });
    
    if (table.settings()[0]._bInitComplete) {
      showContent();
    }
   
    $("#filters").insertBefore("#dayzObjects_wrapper .top-bar");

    $tableEl.addClass('dtr-column');

    var objectFocusEl = document.getElementById('objectFocus');
    var objectFocusNameEl = document.getElementById('objectFocusName');
    var objectFocusPathEl = document.getElementById('objectFocusPath');
    var objectFocusImageEl = document.getElementById('objectFocusImage');
    var objectFocusLinkEl = document.getElementById('objectFocusLink');
    var objectFocusClearEl = document.getElementById('objectFocusClear');
    var objectFocusCopyEl = document.getElementById('objectFocusCopy');
    var objectFocusEditorEl = document.getElementById('objectFocusEditor');
    var objectFocusNameCopyEl = document.getElementById('objectFocusNameCopy');
    var objectFocusMetaEl = document.getElementById('objectFocusMeta');
    var objectFocusEmptyEl = document.getElementById('objectFocusEmpty');
    var currentObjectName = null;
    var currentObjectData = null;
    var currentObjectRowEl = null;
    var pinnedObjectsEl = document.getElementById('pinnedObjects');
    var pinnedListEl = document.getElementById('pinnedList');
    var pinnedClearAllEl = document.getElementById('pinnedClearAll');
    var pinnedCopyAllEl = document.getElementById('pinnedCopyAll');
    var pinnedCopyNamesEl = document.getElementById('pinnedCopyNames');
    var pinnedDownloadAllEl = document.getElementById('pinnedDownloadAll');
    var objectFocusPinEl = document.getElementById('objectFocusPin');
    var objectFocusCollapseEl = document.getElementById('objectFocusCollapse');
    var pinnedItems = [];
    var isPinned = function(objName) {
      return pinnedItems.some(function(item) { return item.objName === objName; });
    };
    var updateCollapseButtonLabel = function() {
      if (!objectFocusCollapseEl || !objectFocusEl) return;
      var isCollapsed = objectFocusEl.classList.contains('collapsed');
      objectFocusCollapseEl.textContent = isCollapsed ? '>>' : '<<';
      objectFocusCollapseEl.setAttribute('aria-label', isCollapsed ? 'Expand sidebar' : 'Collapse sidebar');
    };
    var updateEmptyState = function() {
      if (!objectFocusEl || !objectFocusEmptyEl) return;
      var hasSelection = Boolean(currentObjectName);
      var isCollapsed = objectFocusEl.classList.contains('collapsed');
      objectFocusEl.classList.toggle('empty-state', !hasSelection && !isCollapsed);
      objectFocusEl.classList.toggle('no-selection', !hasSelection);
    };

    if (objectFocusEl) {
      objectFocusEl.classList.add('visible', 'collapsed');
      updateCollapseButtonLabel();
      updateEmptyState();
    }

    var escapeRegex = function(value) {
      return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    };

    var buildObjectUrl = function(objName) {
      var nextUrl = new URL(window.location);
      if (objName) {
        nextUrl.searchParams.set('object', objName);
      } else {
        nextUrl.searchParams.delete('object');
      }
      return nextUrl.toString();
    };

    var buildEditorJson = function(editorJsonRaw, objName, modelType, p3dPath) {
      if (editorJsonRaw && editorJsonRaw.trim() !== "") {
        try {
          var parsed = JSON.parse(editorJsonRaw);
          return JSON.stringify(parsed, null, 4);
        } catch (err) {
          console.error("Invalid editorJson for row:", err);
        }
      }

      var typeValue = (modelType === "Config")
        ? objName
        : p3dPath.replace(/\//g, "\\") + "\\" + objName;

      var json = [{
        Type: typeValue,
        DisplayName: "",
        Position: [0, 0, 0],
        Orientation: [0, 0, 0],
        Scale: 1.0,
        AttachmentMap: {},
        Model: "",
        Flags: 30,
        m_LowBits: 0,
        m_HighBits: 0
      }];

      return JSON.stringify(json, null, 4);
    };

    var hideFocusDetails = function() {
      if (objectFocusEl) {
        objectFocusEl.classList.add('visible');
        objectFocusEl.classList.remove('focus-empty');
      }
      if (objectFocusNameEl) {
        objectFocusNameEl.textContent = '';
      }
      if (objectFocusPathEl) {
        objectFocusPathEl.textContent = '';
      }
      if (objectFocusMetaEl) {
        objectFocusMetaEl.innerHTML = '';
      }
      if (objectFocusImageEl) {
        objectFocusImageEl.innerHTML =
          '<span class="object-focus__missing">Select an object to preview its image.</span>';
      }
      if (objectFocusLinkEl) {
        objectFocusLinkEl.style.display = 'none';
        objectFocusLinkEl.removeAttribute('download');
      }
      currentObjectName = null;
      currentObjectData = null;
      if (currentObjectRowEl) {
        currentObjectRowEl.classList.remove('object-selected');
        currentObjectRowEl = null;
      }
      updateEmptyState();
    };

    var setObjectFocusData = function(objData, updateUrl) {
      if (!objectFocusEl || !objData) return;
      objectFocusEl.classList.remove('focus-empty');
      var objName = objData.objName || '';
      var imgPath = objData.imgPath;
      var p3dPath = objData.p3dPath;
      var modelType = objData.modelType;
      var category = objData.category;
      var inGame = objData.inGame;
      var consoleFlag = objData.consoleFlag;
      var tags = objData.tags;
      var editorJsonRaw = objData.editorJsonRaw;

      currentObjectName = objName;
      currentObjectData = {
        objName: objName,
        imgPath: imgPath,
        p3dPath: p3dPath,
        modelType: modelType,
        editorJsonRaw: editorJsonRaw,
        category: category,
        inGame: inGame,
        consoleFlag: consoleFlag,
        tags: tags
      };
      objectFocusNameEl.textContent = objName;
      objectFocusPathEl.textContent = p3dPath ? ('Path: ' + p3dPath) : '';
      if (objectFocusMetaEl) {
        objectFocusMetaEl.innerHTML =
          '<div><span>In-game name:</span> ' + (inGame || '‚Äî') + '</div>' +
          '<div><span>Category:</span> ' + (category || '‚Äî') + '</div>' +
          '<div><span>Model type:</span> ' + (modelType || '‚Äî') + '</div>' +
          '<div><span>Console:</span> ' + (consoleFlag || '‚Äî') + '</div>' +
          '<div><span>Tags:</span> ' + (tags || '‚Äî') + '</div>';
      }

      if (imgPath) {
        objectFocusImageEl.innerHTML =
          '<img src="/' + imgPath + '" alt="' + objName + ' preview">';
        objectFocusLinkEl.href = '/' + imgPath;
        objectFocusLinkEl.setAttribute('download', objName ? (objName + '.png') : '');
        objectFocusLinkEl.style.display = 'inline-flex';
      } else {
        objectFocusImageEl.innerHTML =
          '<span class="object-focus__missing">No image available for this object.</span>';
        objectFocusLinkEl.style.display = 'none';
      }

      objectFocusEl.classList.add('visible');
      if (objectFocusPinEl) {
        objectFocusPinEl.textContent = isPinned(objName) ? 'üìå Unpin' : 'üìå Pin';
      }
      updateEmptyState();

      if (updateUrl && objName) {
        history.replaceState({}, '', buildObjectUrl(objName));
      }
    };

    var buildPinnedItemFromCell = function($td) {
      return {
        type: 'object',
        objName: $td.data('object') || '',
        imgPath: $td.data('image'),
        p3dPath: $td.data('p3d'),
        modelType: $td.data('modeltype'),
        editorJsonRaw: $td.attr('data-editorjson'),
        category: $td.data('category'),
        inGame: $td.data('ingame'),
        consoleFlag: $td.data('console'),
        tags: $td.data('tags')
      };
    };

    var buildPinnedItemFromRow = function(rowEl) {
      var cell = rowEl ? rowEl.querySelector('.object-name-cell') : null;
      if (!cell) return null;
      return buildPinnedItemFromCell($(cell));
    };

    var addPinnedItem = function(item) {
      if (!item || !item.objName) return;
      var exists = isPinned(item.objName);
      if (exists) return;
      pinnedItems.push(item);
      updatePinnedUI();
    };

    var addPinnedPathItem = function(pathValue, rows) {
      if (!pathValue) return;
      var exists = pinnedItems.some(function(item) {
        return item.type === 'path' && item.p3dPath === pathValue;
      });
      if (exists) {
        pinnedItems = pinnedItems.filter(function(item) {
          return item.type !== 'path' || item.p3dPath !== pathValue;
        });
        updatePinnedUI();
        return;
      }
      var items = rows.map(function(rowEl) {
        var item = buildPinnedItemFromRow(rowEl);
        if (item) {
          item.sourcePath = pathValue;
        }
        return item;
      }).filter(Boolean);
      pinnedItems.push({
        type: 'path',
        objName: pathValue,
        p3dPath: pathValue,
        items: items,
        count: items.length
      });
      updatePinnedUI();
    };

    var removePinnedItemByName = function(objName) {
      if (!objName) return;
      pinnedItems = pinnedItems.filter(function(item) {
        if (item.type === 'path') {
          return item.p3dPath !== objName && item.objName !== objName;
        }
        return item.objName !== objName;
      });
      updatePinnedUI();
    };

    var getPinnedEntries = function() {
      var entries = [];
      pinnedItems.forEach(function(item) {
        if (item.type === 'path') {
          if (Array.isArray(item.items)) {
            entries = entries.concat(item.items);
          }
        } else {
          entries.push(item);
        }
      });
      return entries;
    };

    var savePinnedItems = function() {
      try {
        localStorage.setItem('dayzPinnedObjects', JSON.stringify(pinnedItems));
      } catch (err) {
        console.warn('Unable to save pinned objects:', err);
      }
    };

    var loadPinnedItems = function() {
      try {
        var stored = localStorage.getItem('dayzPinnedObjects');
        if (!stored) return [];
        var parsed = JSON.parse(stored);
        return Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        console.warn('Unable to load pinned objects:', err);
        return [];
      }
    };

    var updatePinnedUI = function() {
      if (!pinnedObjectsEl || !pinnedListEl || !objectFocusEl) return;
      pinnedListEl.innerHTML = '';

      pinnedItems.forEach(function(item) {
        if (item.type === 'path' && !item.count && Array.isArray(item.items)) {
          item.count = item.items.length;
        }
        var wrapper = document.createElement('div');
        wrapper.className = 'pinned-item';
        wrapper.setAttribute('data-object', item.objName || '');

        var thumb = document.createElement('div');
        thumb.className = 'pinned-thumb';
        if (item.imgPath && item.type !== 'path') {
          var img = document.createElement('img');
          img.src = '/' + item.imgPath;
          img.alt = (item.objName || 'Object') + ' preview';
          thumb.appendChild(img);
        } else {
          thumb.textContent = item.type === 'path' ? 'Path' : 'No image';
        }

        var name = document.createElement('div');
        name.className = 'pinned-name';
        if (item.type === 'path') {
          name.textContent = (item.p3dPath || item.objName || 'Path') + ' (' + (item.count || 0) + ' objects)';
        } else {
          name.textContent = item.objName || 'Unknown';
        }

        var actions = document.createElement('div');
        actions.className = 'pinned-actions';

        var removeBtn = document.createElement('button');
        removeBtn.className = 'pinned-remove';
        removeBtn.type = 'button';
        removeBtn.textContent = 'üÜá';
        removeBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          pinnedItems = pinnedItems.filter(function(pinned) {
            if (item.type === 'path') {
              return pinned.type !== 'path' || pinned.p3dPath !== item.p3dPath;
            }
            return pinned.objName !== item.objName;
          });
          updatePinnedUI();
        });

        if (item.type !== 'path') {
          var editorBtn = document.createElement('button');
          editorBtn.className = 'pinned-action-btn';
          editorBtn.type = 'button';
          editorBtn.title = 'Copy to Editor';
          editorBtn.textContent = 'üèóÔ∏è';
          editorBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            var jsonText = buildEditorJson(
              item.editorJsonRaw,
              item.objName,
              item.modelType,
              item.p3dPath
            );
            navigator.clipboard.writeText(jsonText);
            var original = editorBtn.textContent;
            editorBtn.textContent = '‚úî';
            setTimeout(function() { editorBtn.textContent = original; }, 900);
          });

          var nameBtn = document.createElement('button');
          nameBtn.className = 'pinned-action-btn';
          nameBtn.type = 'button';
          nameBtn.title = 'Copy name';
          nameBtn.textContent = 'üìã';
          nameBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (!item.objName) return;
            navigator.clipboard.writeText(item.objName);
            var original = nameBtn.textContent;
            nameBtn.textContent = '‚úî';
            setTimeout(function() { nameBtn.textContent = original; }, 900);
          });

          actions.appendChild(editorBtn);
          actions.appendChild(nameBtn);
        }

        wrapper.addEventListener('click', function(e) {
          if (e.target.closest('.pinned-remove')) return;
          if (objectFocusEl && objectFocusEl.classList.contains('collapsed')) {
            objectFocusEl.classList.remove('collapsed');
            updateCollapseButtonLabel();
            updateEmptyState();
          }
          if (item.type === 'path') return;
          if (objectFocusEl && objectFocusEl.classList.contains('visible') && currentObjectName === item.objName) {
            hideFocusDetails();
            return;
          }
          setObjectFocusData({
            objName: item.objName,
            imgPath: item.imgPath,
            p3dPath: item.p3dPath,
            modelType: item.modelType,
            editorJsonRaw: item.editorJsonRaw,
            category: item.category,
            inGame: item.inGame,
            consoleFlag: item.consoleFlag,
            tags: item.tags
          }, false);
        });

        wrapper.appendChild(thumb);
        actions.appendChild(removeBtn);
        wrapper.appendChild(name);
        wrapper.appendChild(actions);
        pinnedListEl.appendChild(wrapper);
      });

      if (pinnedItems.length > 0) {
        pinnedObjectsEl.classList.remove('is-empty');
        objectFocusEl.classList.add('has-pins');
      } else {
        pinnedObjectsEl.classList.add('is-empty');
        objectFocusEl.classList.remove('has-pins');
      }

      var hasPins = pinnedItems.length > 0;
      if (pinnedCopyAllEl) {
        pinnedCopyAllEl.classList.toggle('visible', hasPins);
      }

      if (pinnedCopyNamesEl) {
        pinnedCopyNamesEl.classList.toggle('visible', hasPins);
      }

      if (pinnedDownloadAllEl) {
        pinnedDownloadAllEl.classList.toggle('visible', hasPins);
      }

      if (pinnedClearAllEl) {
        pinnedClearAllEl.classList.toggle('visible', hasPins);
      }

      savePinnedItems();
      updateEmptyState();
    };

    pinnedItems = loadPinnedItems();
    updatePinnedUI();

    var buildEditorJsonArray = function(item) {
      var jsonText = buildEditorJson(
        item.editorJsonRaw,
        item.objName,
        item.modelType,
        item.p3dPath
      );
      try {
        var parsed = JSON.parse(jsonText);
        return Array.isArray(parsed) ? parsed : [parsed];
      } catch (err) {
        console.error('Invalid editor JSON for pinned item:', err);
        return [];
      }
    };

    var showObjectFocus = function($td, updateUrl) {
      if (!objectFocusEl || !$td || !$td.length) return;
      if (currentObjectRowEl) {
        currentObjectRowEl.classList.remove('object-selected');
      }
      if (objectFocusEl.classList.contains('collapsed')) {
        objectFocusEl.classList.remove('collapsed');
        updateCollapseButtonLabel();
        updateEmptyState();
      }
      currentObjectRowEl = $td.closest('tr').get(0);
      if (currentObjectRowEl) {
        currentObjectRowEl.classList.add('object-selected');
      }
      setObjectFocusData({
        objName: $td.data('object') || '',
        imgPath: $td.data('image'),
        p3dPath: $td.data('p3d'),
        modelType: $td.data('modeltype'),
        category: $td.data('category'),
        inGame: $td.data('ingame'),
        consoleFlag: $td.data('console'),
        tags: $td.data('tags'),
        editorJsonRaw: $td.attr('data-editorjson')
      }, updateUrl);
    };

    var showMissingObject = function(objName) {
      if (!objectFocusEl) return;
      currentObjectName = objName;
      objectFocusNameEl.textContent = objName;
      objectFocusPathEl.textContent = 'No exact match found.';
      if (objectFocusMetaEl) {
        objectFocusMetaEl.innerHTML = '';
      }
      objectFocusImageEl.innerHTML =
        '<span class="object-focus__missing">No image available for this object.</span>';
      objectFocusLinkEl.style.display = 'none';
      objectFocusEl.classList.add('visible');
      updateEmptyState();
    };

    var focusByName = function(objName) {
      if (!objName) return;
      var normalized = objName.trim();
      if (!normalized) return;

      var matchCell = $(table.rows().nodes()).find('.object-name-cell').filter(function() {
        var value = $(this).data('object');
        return value && String(value).toLowerCase() === normalized.toLowerCase();
      }).first();

      if (!matchCell.length) {
        showMissingObject(normalized);
        return;
      }

      showObjectFocus(matchCell, false);
      table.column(1).search('^' + escapeRegex(normalized), true, false).draw();
      table.one('draw', function() {
        var $cell = $tableEl.find('tbody .object-name-cell').filter(function() {
          var value = $(this).data('object');
          return value && String(value).toLowerCase() === normalized.toLowerCase();
        }).first();

        if ($cell.length) {
          showObjectFocus($cell, false);
          var rowEl = $cell.closest('tr').get(0);
          if (rowEl && rowEl.scrollIntoView) {
            rowEl.classList.add('flash');
            rowEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(function() { rowEl.classList.remove('flash'); }, 1200);
          }
        }
      });
    };

    if (objectFocusClearEl) {
      objectFocusClearEl.addEventListener('click', function() {
        table.column(1).search('').draw();
        hideFocusDetails();
        history.replaceState({}, '', buildObjectUrl(''));
      });
    }

    if (objectFocusCopyEl) {
      objectFocusCopyEl.addEventListener('click', function() {
        var link = buildObjectUrl(currentObjectName || objectFocusNameEl.textContent || '');
        navigator.clipboard.writeText(link);
        var original = objectFocusCopyEl.textContent;
        objectFocusCopyEl.textContent = 'Copied';
        setTimeout(function() { objectFocusCopyEl.textContent = original; }, 1200);
      });
    }

    if (objectFocusEditorEl) {
      objectFocusEditorEl.addEventListener('click', function() {
        if (!currentObjectData) return;
        var jsonText = buildEditorJson(
          currentObjectData.editorJsonRaw,
          currentObjectData.objName,
          currentObjectData.modelType,
          currentObjectData.p3dPath
        );
        navigator.clipboard.writeText(jsonText);
        var original = objectFocusEditorEl.textContent;
        objectFocusEditorEl.textContent = 'Copied';
        setTimeout(function() { objectFocusEditorEl.textContent = original; }, 1200);
      });
    }

    if (objectFocusNameCopyEl) {
      objectFocusNameCopyEl.addEventListener('click', function() {
        var nameText = currentObjectName || objectFocusNameEl.textContent || '';
        if (!nameText) return;
        navigator.clipboard.writeText(nameText);
        var original = objectFocusNameCopyEl.textContent;
        objectFocusNameCopyEl.textContent = 'Copied';
        setTimeout(function() { objectFocusNameCopyEl.textContent = original; }, 1200);
      });
    }

    if (objectFocusPinEl) {
      objectFocusPinEl.addEventListener('click', function() {
        if (!currentObjectData || !currentObjectData.objName) return;
        var exists = isPinned(currentObjectData.objName);
        if (exists) {
          pinnedItems = pinnedItems.filter(function(item) {
            return item.objName !== currentObjectData.objName;
          });
          updatePinnedUI();
          if (objectFocusPinEl) {
            objectFocusPinEl.textContent = 'üìå Pin';
          }
          return;
        }
        pinnedItems.push({
          objName: currentObjectData.objName,
          imgPath: currentObjectData.imgPath,
          p3dPath: currentObjectData.p3dPath,
          modelType: currentObjectData.modelType,
          editorJsonRaw: currentObjectData.editorJsonRaw,
          category: currentObjectData.category,
          inGame: currentObjectData.inGame,
          consoleFlag: currentObjectData.consoleFlag,
          tags: currentObjectData.tags
        });
        updatePinnedUI();
        hideFocusDetails();
      });
    }

    if (pinnedCopyNamesEl) {
      pinnedCopyNamesEl.addEventListener('click', function() {
        var entries = getPinnedEntries();
        if (!entries.length) return;
        var names = entries.map(function(item) { return item.objName; }).filter(Boolean);
        if (!names.length) return;
        navigator.clipboard.writeText(names.join('\n'));
        pinnedCopyNamesEl.textContent = '‚úî';
        setTimeout(function() { pinnedCopyNamesEl.textContent = 'üìã'; }, 900);
      });
    }

    if (objectFocusCollapseEl) {
      objectFocusCollapseEl.addEventListener('click', function() {
        if (!objectFocusEl) return;
        objectFocusEl.classList.toggle('collapsed');
        updateCollapseButtonLabel();
        updateEmptyState();
      });
    }

    if (pinnedCopyAllEl) {
      pinnedCopyAllEl.addEventListener('click', function() {
        var entries = getPinnedEntries();
        if (!entries.length) return;
        var combined = [];
        var cursor = 0;
        var spacingBase = 10;
        entries.forEach(function(item) {
          var objects = buildEditorJsonArray(item);
          objects.forEach(function(obj) {
            var scale = 1;
            if (obj && obj.Scale !== undefined && obj.Scale !== null) {
              var parsedScale = parseFloat(obj.Scale);
              if (!isNaN(parsedScale) && isFinite(parsedScale)) {
                scale = parsedScale;
              }
            }
            if (!obj.Position || obj.Position.length < 3) {
              obj.Position = [0, 0, 0];
            }
            obj.Position[0] = cursor;
            cursor += spacingBase * scale;
            combined.push(obj);
          });
        });
        if (!combined.length) return;
        navigator.clipboard.writeText(JSON.stringify(combined, null, 4));
        pinnedCopyAllEl.textContent = '‚úî';
        setTimeout(function() { pinnedCopyAllEl.textContent = 'üèóÔ∏è'; }, 900);
      });
    }

    if (pinnedClearAllEl) {
      pinnedClearAllEl.addEventListener('click', function() {
        if (!pinnedItems.length) return;
        pinnedItems = [];
        updatePinnedUI();
        if (objectFocusPinEl && currentObjectName) {
          objectFocusPinEl.textContent = 'üìå Pin';
        }
      });
    }

    var csvEscape = function(value) {
      if (value === null || value === undefined) return '';
      var str = String(value);
      if (str.indexOf('"') !== -1 || str.indexOf(',') !== -1 || str.indexOf('\n') !== -1 || str.indexOf('\r') !== -1) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    };
    var sanitizePathFolder = function(value) {
      if (!value) return 'unknown';
      return String(value)
        .replace(/[\\\/]+/g, '_')
        .replace(/[^a-zA-Z0-9._-]/g, '_')
        .slice(0, 80);
    };

    if (pinnedDownloadAllEl) {
      pinnedDownloadAllEl.addEventListener('click', function() {
        var entries = getPinnedEntries();
        if (!entries.length) return;
        if (typeof JSZip === 'undefined' || typeof saveAs === 'undefined') return;

        var zip = new JSZip();
        var csvRows = [];
        csvRows.push([
          'className',
          'inGameName',
          'category',
          'path',
          'console',
          'type',
          'tags',
          'image',
          'imageFound'
        ].join(','));

        var imagePromises = entries.map(function(item) {
          var imageFound = item.imgPath ? 'Yes' : 'No';
          csvRows.push([
            csvEscape(item.objName),
            csvEscape(item.inGame),
            csvEscape(item.category),
            csvEscape(item.p3dPath),
            csvEscape(item.consoleFlag === '‚úÖ' ? 'Yes' : item.consoleFlag === '‚ùå' ? 'No' : item.consoleFlag),
            csvEscape(item.modelType),
            csvEscape(item.tags),
            csvEscape(item.imgPath),
            csvEscape(imageFound)
          ].join(','));

          if (!item.imgPath) return Promise.resolve();
          return fetch('/' + item.imgPath)
            .then(function(response) {
              if (!response.ok) throw new Error('Image fetch failed');
              return response.blob();
            })
            .then(function(blob) {
              var name = item.objName ? (item.objName + '.png') : item.imgPath.split('/').pop();
              if (item.sourcePath) {
                zip.file('images/' + sanitizePathFolder(item.sourcePath) + '/' + name, blob);
              } else {
                zip.file('images/' + name, blob);
              }
            })
            .catch(function() {});
        });

        zip.file('objects.csv', csvRows.join('\n'));

        Promise.all(imagePromises).then(function() {
          return zip.generateAsync({ type: 'blob' });
        }).then(function(content) {
          saveAs(content, 'dayz_objects.zip');
        }).catch(function() {});
      });
    }

    var searchParams = new URLSearchParams(window.location.search);
    var objectParam = searchParams.get('object');
    if (objectParam) {
      focusByName(objectParam);
    }


    var categories = [];
    table.column(3).data().each(function(value) {
      if (value && categories.indexOf(value) === -1) {
        categories.push(value);
      }
    });
    categories.sort().forEach(function(cat) {
      $('#filterCategory').append('<option value="' + cat + '">' + cat + '</option>');
    });

    $('#filterCategory').on('change', function() {
      table.column(3).search(this.value).draw();
    });

    $('#filterConsole').on('change', function() {
      table.column(5).search(this.value).draw();
    });

    $('#resetFilters').on('click', function() {
      table.search('').columns().search('').draw();
      $('#filterCategory').val('').trigger('change');
      $('#filterConsole').val('').trigger('change');
      if (presetsActive) {
        presetsActive = false;
        previousCategoryValue = '';
        $('#togglePresets').removeClass('active').text('Show presets');
      }
      hideFocusDetails();
      if (objectFocusEl) {
        objectFocusEl.classList.add('visible', 'collapsed');
        updateCollapseButtonLabel();
        updateEmptyState();
      }
      var nextUrl = new URL(window.location);
      nextUrl.searchParams.delete('object');
      history.replaceState({}, '', nextUrl);
    });

    var presetsCategoryValue = "Editor Preset";
    var presetsActive = false;
    var previousCategoryValue = "";

    $('#togglePresets').on('click', function() {
      var $btn = $(this);

      if (!presetsActive) {
        previousCategoryValue = $('#filterCategory').val();
        $('#filterCategory').val(presetsCategoryValue).trigger('change');
        presetsActive = true;
        $btn.addClass('active').text('Show all');
      } else {
        $('#filterCategory').val(previousCategoryValue).trigger('change');
        presetsActive = false;
        $btn.removeClass('active').text('Show presets');
      }
    });

    $('#dayzObjects tbody')
      .on('mouseenter', '.object-name-cell', function(e) {
        var imgPath = $(this).data('image');
        if (!imgPath) return;

        $('body').append(
          '<div id="imgPreview" class="preview-card">' +
            '<img src="/' + imgPath + '" alt="Object preview">' +
          '</div>'
        );
        $('#imgPreview').css({ top: e.pageY + 10, left: e.pageX + 10 });
      })
      .on('mousemove', '.object-name-cell', function(e) {
        $('#imgPreview').css({ top: e.pageY + 10, left: e.pageX + 10 });
      })
      .on('mouseleave', '.object-name-cell', function() {
        $('#imgPreview').remove();
      });

    $('#dayzObjects tbody').on('click', '.object-name-cell', function(e) {
      if ($(e.target).hasClass('copy-btn')) return;
      var objName = $(this).data('object');
      if (objectFocusEl && objectFocusEl.classList.contains('visible') && currentObjectName === objName) {
        hideFocusDetails();
        return;
      }
      showObjectFocus($(this), false);
    });

    $('#dayzObjects tbody').on('click', '.copy-btn:not(.editor-copy-btn):not(.pin-btn)', function(e) {
      e.stopPropagation();
      var text = $(this).closest('td').data('object');
      navigator.clipboard.writeText(text);
      var $btn = $(this);
      $btn.text('‚úî');
      setTimeout(function() { $btn.text('üìã'); }, 1000);
    });

    $('#dayzObjects tbody').on('click', '.pin-btn', function(e) {
      e.stopPropagation();
      var $td = $(this).closest('td');
      var item = buildPinnedItemFromCell($td);
      var $btn = $(this);
      var original = $btn.text();
      if (isPinned(item.objName)) {
        removePinnedItemByName(item.objName);
      } else {
        addPinnedItem(item);
      }
      $btn.text('‚úî');
      setTimeout(function() { $btn.text(original); }, 900);
    });

    $('#dayzObjects tbody').on('click', '.path-pin-btn', function(e) {
      e.stopPropagation();
      var $cell = $(this).closest('td');
      var $row = $cell.closest('tr');
      var $nameCell = $row.find('.object-name-cell');
      var pathValue = $nameCell.data('p3d') || $cell.text().trim();
      if (!pathValue) return;
      var rows = [];
      $(table.rows().nodes()).each(function() {
        var cell = this.querySelector('.object-name-cell');
        if (!cell) return;
        if (cell.getAttribute('data-p3d') === pathValue) {
          rows.push(this);
        }
      });
      addPinnedPathItem(pathValue, rows);
      var $btn = $(this);
      var original = $btn.text();
      $btn.text('‚úî');
      setTimeout(function() { $btn.text(original); }, 900);
    });

    $('#dayzObjects tbody').on('click', '.editor-copy-btn', function(e) {
      e.stopPropagation();
      var $td = $(this).closest('td');

      var predefined = $td.attr('data-editorjson');
      var jsonText = null;

      if (predefined && predefined.trim() !== "") {
        try {
          var parsed = JSON.parse(predefined); 
          jsonText = JSON.stringify(parsed, null, 4);
        } catch (err) {
          console.error("Invalid editorJson for row:", err);
        }
      }

      if (!jsonText) {
        var objName   = $td.data('object');
        var modelType = $td.data('modeltype');
        var path      = $td.data('p3d');

        var typeValue = (modelType === "Config")
          ? objName
          : path.replace(/\//g, "\\") + "\\" + objName;

        var json = [{
          Type: typeValue,
          DisplayName: "",
          Position: [0, 0, 0],
          Orientation: [0, 0, 0],
          Scale: 1.0,
          AttachmentMap: {},
          Model: "",
          Flags: 30,
          m_LowBits: 0,
          m_HighBits: 0
        }];

        jsonText = JSON.stringify(json, null, 4);
      }

      navigator.clipboard.writeText(jsonText);

      var $btn = $(this);
      $btn.text('‚úî');
      setTimeout(function() { $btn.text('üèóÔ∏è'); }, 1000);
    });
  });
</script>

{{ end }}

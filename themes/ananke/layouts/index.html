{{ define "head" }}
  {{ partials.Include "head-additions.html" . }}
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
  <style>
    
    #dayzObjects,
    #dayzObjects_wrapper {
      visibility: hidden;
    }
  </style>
{{ end }}

{{ define "main" }}
{{ $objectCount := len .Site.Data.dayz_objects }}

<style>
  .annoucenment-bar {
    background-color: var(--card);
    color: var(--text);
    padding: 6px 8px;
    margin: 2px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-soft);
  }

  
  #dayzObjects_wrapper {
    width: 95% !important;
    margin: 20px auto;
    overflow-x: auto;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 4px;
    box-shadow: var(--shadow-soft);
    padding: 14px 14px 18px;
  }
  #dayzObjects { width: 100% !important; }

  
  .top-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
  }
  .top-bar select,
  .top-bar input {
    margin-right: 10px;
  }
  #filters {
    display: none;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
    align-items: center;
    padding: 0;
    border-radius: 4px;
    border: none;
    background-color: var(--card);
    box-shadow: none;
  }
  #filters label {
    font-weight: 600;
    color: var(--text);
  }
  .filter-actions {
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }
  .dataTables_length label,
  .dataTables_filter label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: var(--text);
    font-size: 0.95rem;
  }
  .dataTables_length select,
  .dataTables_filter input {
    border-radius: 6px;
  }
  .dataTables_info {
    border: none !important;
  }
  #dayzObjects_filter input {
    width: 250px;
    max-width: 100%;
    background-color: var(--input-bg);
    color: var(--text);
    border: 1px solid var(--input-border);
  }
  @media (max-width: 768px) {
    #filters {
      flex-direction: column;
      align-items: stretch;
    }
    #filters label,
    #filters select {
      width: 100%;
    }
    #dayzObjects { font-size: 12px; }
  }
  @media (max-width: 480px) {
    #dayzObjects { font-size: 10px; }
  }

  
  #dayzObjects tbody td:first-child {
    position: relative;
  }

  .copy-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    cursor: pointer;
    border: 1px solid #6b7280;
    background-color: #6b7280;
    color: #fff;
    font-size: 1em;
    opacity: 0;
    transition: opacity 0.15s ease;
    padding: 2px 4px;
    border-radius: 2px;
  }

  
  #dayzObjects tbody td:first-child:hover .copy-btn {
    opacity: 1;
  }

  
  .copy-btn + .copy-btn {
    right: 40px;
  }

  .copy-btn:hover {
    background-color: #4b5563;
    border-color: #4b5563;
    color: #fff;
  }

  
  #togglePresets {
    padding: 8px 12px;
    font-size: 0.95rem;
  }

  #togglePresets.active {
    background-color: var(--accent);
    color: #111;
    border-color: var(--accent);
  }

  
  @keyframes flash-highlight {
    0% { background-color: rgba(242, 183, 0, 0.28); }
    100% { background-color: transparent; }
  }
  .flash {
    animation: flash-highlight 1s ease-out;
  }

  #loadingIndicator {
    margin: 40px 0 8px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-align: center;
    color: var(--text);
  }

  
  #statusMessage {
    margin: 18px 0 0;
    text-align: center;
    font-weight: 500;
    font-style: italic;
    color: var(--muted);
  }

  #imgPreview img {
    max-width: 400px;
    max-height: 400px;
    display: block;
    border-radius: 3px;
  }
</style>

<div id="filters">
  <label for="filterCategory">Category:</label>
  <select id="filterCategory">
    <option value="">All</option>
  </select>

  <label for="filterConsole">Usable on Console:</label>
  <select id="filterConsole">
    <option value="">All</option>
    <option value="‚úÖ">Yes</option>
    <option value="‚ùå">No</option>
  </select>

  <div class="filter-actions">
    <button id="togglePresets" class="pill-button" type="button">Show presets</button>
    <button id="themeToggle" class="pill-button theme-toggle" type="button" aria-live="polite">
      Dark mode
    </button>
  </div>
</div>

<div id="loadingIndicator">
  Loading {{ $objectCount }} objects...
</div>

<div id="statusMessage"></div>

<table id="dayzObjects" class="display nowrap" style="width:100%">
  <thead>
    <tr>
      <th>Object name</th>
      <th>In-game name</th>
      <th>Category</th>
      <th>Model Type</th>
      <th>Path</th>
      <th>Console</th>
      <th>Search Tags</th>
    </tr>
  </thead>
  <tbody>
    {{ range .Site.Data.dayz_objects }}
    <tr>
      <td
        data-object="{{ .objectName }}"
        data-p3d="{{ .path }}"
        data-modeltype="{{ .modelType }}"
        data-image="{{ with .image }}{{ . }}{{ end }}"
        data-editorjson='{{ with .editorJson }}{{ . | jsonify }}{{ end }}'
      >
        {{ .objectName }}
        <button class="copy-btn" title="Copy object name">üìã</button>
        <button class="copy-btn editor-copy-btn" title="Copy DayZ Editor JSON">üèóÔ∏è</button>
      </td>
      <td>{{ .inGameName }}</td>
      <td>{{ .category }}</td>
      <td>{{ .modelType }}</td>
      <td>{{ .path }}</td>
      <td>{{ if .usableOnConsole }}‚úÖ{{ else }}‚ùå{{ end }}</td>
      <td>{{ with .searchTags }}{{ . }}{{ end }}</td>
    </tr>
    {{ end }}
  </tbody>
</table>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<script>
  var statusMessages = [
    'This project is a work in progress - add feedback on the Discord',
	'There are more than 190 hats in DayZ - Sam‚Äôs favourite is the Zimikova',
	'The only P3Ds you can use on console are rocks and plants',
	'Working on console? Filter by console and look for the ‚úÖ mark',
	'You can copy and paste directly into DayZ Editor using the üèóÔ∏è button',
	'DayZ uses the scientific names for plants and animals - but you can just search for "birch" or "wolf"',
	'There are more than 60 different types of birch tree in DayZ',
	'There are more than 40 different types of armbands in DayZ',
	'The most annoying type of object to categorise was railway tracks',
	'There are several invisible ghost assets used for development - they may also be haunted',
	'There are nine types of mushroom in DayZ',
	'There are 31 different playable Survivors in DayZ',
	'You can add size and colour to your searches for large rocks or green bags',
	'Notice an error? Well done, you get a gold star. Report it on the Discord',
	'Sam spent too long categorising fences',
	'If you keep refreshing the page, you will eventually see all these messages',
	'Put your credit card into this website to unlock the object list WITHOUT the errors',
	'There are more than 90 different types of spruce tree in DayZ',
	'There are 45 different houses in DayZ - each has been tagged with its callouts',
	'This loading message hides many sins'
  ];
  (function() {
    var statusMessageEl = document.getElementById('statusMessage');
    if (!statusMessageEl) return;
    statusMessageEl.textContent = statusMessages[Math.floor(Math.random() * statusMessages.length)];
    statusMessageEl.style.display = 'block';
  })();

  $(document).ready(function() {
    var statusMessageEl = document.getElementById('statusMessage');
    var $tableEl = $('#dayzObjects');
    $('#filters').hide();

    var showContent = function() {
      $('#dayzObjects, #dayzObjects_wrapper').css('visibility', 'visible');
      $('#loadingIndicator').hide();
      $('#filters').css('display', 'flex');
      if (statusMessageEl) {
        statusMessageEl.style.display = 'none';
      }
    };
    
    $tableEl.one('init.dt', showContent);

    var table = $tableEl.DataTable({
      responsive: true,
      pageLength: 50,
      lengthMenu: [[50,100,200,500],[50,100,200,500]],
      columnDefs: [{ targets: [6], visible: true }],
      dom: '<"top-bar"lfr>tip',
      language: {
        search: "Search: ",
        searchPlaceholder: "'large snow rock', '308 rifles'"
      }
    });
    
    if (table.settings()[0]._bInitComplete) {
      showContent();
    }
   
    $("#filters").insertBefore("#dayzObjects_wrapper .top-bar");


    var categories = [];
    table.column(2).data().each(function(value) {
      if (value && categories.indexOf(value) === -1) {
        categories.push(value);
      }
    });
    categories.sort().forEach(function(cat) {
      $('#filterCategory').append('<option value="' + cat + '">' + cat + '</option>');
    });

    $('#filterCategory').on('change', function() {
      table.column(2).search(this.value).draw();
    });

    $('#filterConsole').on('change', function() {
      table.column(5).search(this.value).draw();
    });

    // Preset toggle 
    var presetsCategoryValue = "Editor Preset";
    var presetsActive = false;
    var previousCategoryValue = "";

    $('#togglePresets').on('click', function() {
      var $btn = $(this);

      if (!presetsActive) {
        // remember old category
        previousCategoryValue = $('#filterCategory').val();
        $('#filterCategory').val(presetsCategoryValue).trigger('change');
        presetsActive = true;
        $btn.addClass('active').text('Show all');
      } else {
        // restore previous category selection
        $('#filterCategory').val(previousCategoryValue).trigger('change');
        presetsActive = false;
        $btn.removeClass('active').text('Show presets');
      }
    });

    // Hover image preview on first column
    $('#dayzObjects tbody')
      .on('mouseenter', 'td:first-child', function(e) {
        var imgPath = $(this).data('image');
        if (!imgPath) return;

        $('body').append(
          '<div id="imgPreview" class="preview-card">' +
            '<img src="/' + imgPath + '" alt="Object preview">' +
          '</div>'
        );
        $('#imgPreview').css({ top: e.pageY + 10, left: e.pageX + 10 });
      })
      .on('mousemove', 'td:first-child', function(e) {
        $('#imgPreview').css({ top: e.pageY + 10, left: e.pageX + 10 });
      })
      .on('mouseleave', 'td:first-child', function() {
        $('#imgPreview').remove();
      });

    // Copy object name (üìã)
    $('#dayzObjects tbody').on('click', '.copy-btn:not(.editor-copy-btn)', function(e) {
      e.stopPropagation();
      var text = $(this).closest('td').data('object');
      navigator.clipboard.writeText(text);
      var $btn = $(this);
      $btn.text('‚úî');
      setTimeout(function() { $btn.text('üìã'); }, 1000);
    });

    // Copy DayZ Editor JSON (üèóÔ∏è) 
    $('#dayzObjects tbody').on('click', '.editor-copy-btn', function(e) {
      e.stopPropagation();
      var $td = $(this).closest('td');

      // 
      var predefined = $td.attr('data-editorjson');
      var jsonText = null;

      if (predefined && predefined.trim() !== "") {
        try {
          var parsed = JSON.parse(predefined); 
          // Copy as a valid JSON array of separate items
          jsonText = JSON.stringify(parsed, null, 4);
        } catch (err) {
          console.error("Invalid editorJson for row:", err);
        }
      }

      // 
      if (!jsonText) {
        var objName   = $td.data('object');
        var modelType = $td.data('modeltype');
        var path      = $td.data('p3d');

        var typeValue = (modelType === "Config")
          ? objName
          : path.replace(/\//g, "\\") + "\\" + objName;

        var json = [{
          Type: typeValue,
          DisplayName: "",
          Position: [0, 0, 0],
          Orientation: [0, 0, 0],
          Scale: 1.0,
          AttachmentMap: {},
          Model: "",
          Flags: 30,
          m_LowBits: 0,
          m_HighBits: 0
        }];

        jsonText = JSON.stringify(json, null, 4);
      }

      
      navigator.clipboard.writeText(jsonText);

     
      var $btn = $(this);
      $btn.text('‚úî');
      setTimeout(function() { $btn.text('üèóÔ∏è'); }, 1000);
    });
  });
</script>

{{ end }}

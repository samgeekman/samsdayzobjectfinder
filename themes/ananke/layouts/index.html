{{ define "head" }}
  {{ partials.Include "head-additions.html" . }}
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
  <style>
    
    #dayzObjects,
    #dayzObjects_wrapper {
      visibility: hidden;
    }
  </style>
{{ end }}

{{ define "main" }}
{{ $objectCount := len .Site.Data.dayz_objects }}

<style>
  html,
  body {
    max-width: 100%;
    overflow-x: hidden;
  }
  .annoucenment-bar {
    background-color: var(--card);
    color: var(--text);
    padding: 6px 8px;
    margin: 2px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-soft);
  }
  footer[role="contentinfo"] {
    padding: 0.75rem;
    padding-bottom: 4rem;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 120px;
  }

  
  #dayzObjects_wrapper {
    width: 95% !important;
    margin: 20px auto;
    overflow-x: hidden;
    max-width: 100%;
    box-sizing: border-box;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 4px;
    box-shadow: var(--shadow-soft);
    padding: 14px 14px 18px;
  }
  #dayzObjects { width: 100% !important; }

  
  .top-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
  }
  .top-bar select,
  .top-bar input {
    margin-right: 10px;
  }
  #filters {
    display: none;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
    align-items: center;
    padding: 0;
    border-radius: 4px;
    border: none;
    background-color: var(--card);
    box-shadow: none;
  }
  #filters label {
    font-weight: 600;
    color: var(--text);
  }
  .filter-actions {
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }
  .dataTables_length label,
  .dataTables_filter label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: var(--text);
    font-size: 0.95rem;
  }
  .dataTables_length select,
  .dataTables_filter input {
    border-radius: 6px;
  }
  .dataTables_length select {
    background-color: var(--input-bg);
    color: var(--text);
    border: 1px solid var(--input-border);
  }
  .dataTables_info {
    border: none !important;
  }
  #dayzObjects_filter input {
    width: 250px;
    max-width: 100%;
    background-color: var(--input-bg);
    color: var(--text);
    border: 1px solid var(--input-border);
  }
  @media (max-width: 768px) {
    #filters {
      flex-direction: column;
      align-items: stretch;
    }
    #filters label,
    #filters select {
      width: 100%;
    }
    #dayzObjects { font-size: 11px; }
    #dayzObjects td,
    #dayzObjects th {
      padding: 6px 8px;
    }
    .copy-btn,
    .path-cell .path-pin-btn,
    .path-cell .path-link-btn {
      display: none !important;
    }
  }
  @media (max-width: 480px) {
    #dayzObjects { font-size: 10px; }
    #dayzObjects td,
    #dayzObjects th {
      padding: 5px 6px;
    }
  }
  @media (max-width: 1360px) {
    #dayzObjects td,
    #dayzObjects th {
      white-space: nowrap !important;
      text-overflow: ellipsis;
      overflow: hidden;
    }
  }

  
  #dayzObjects tbody .object-name-cell {
    position: relative;
    cursor: pointer;
    user-select: none;
  }
  #dayzObjects tbody .path-cell {
    position: relative;
  }
  #dayzObjects tbody .thumb-cell {
    width: 40px;
    text-align: center;
    padding: 2px 4px !important;
    vertical-align: middle;
  }
  #dayzObjects tbody .thumb-img {
    width: 32px;
    height: 32px;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #374151;
    background: #111827;
    display: block;
    margin: 0 auto;
  }
  #dayzObjects tbody tr {
    height: 40px;
  }
  #dayzObjects tbody td,
  #dayzObjects tbody th {
    vertical-align: middle;
    line-height: 32px;
  }
  #dayzObjects tbody .thumb-cell {
    width: 32px;
    min-width: 32px;
    max-width: 32px;
    padding: 0 !important;
  }
  #dayzObjects tbody .thumb-fallback {
    color: #6b7280;
    font-size: 0.85em;
  }
  #dayzObjects tbody tr.object-selected {
    outline: 1px solid var(--accent);
    outline-offset: -1px;
  }

  .copy-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    cursor: pointer;
    border: 1px solid #6b7280;
    background-color: #6b7280;
    color: #fff;
    font-size: 1em;
    opacity: 0;
    transition: opacity 0.15s ease;
    padding: 2px 4px;
    border-radius: 2px;
  }

  
  #dayzObjects tbody .object-name-cell:hover .copy-btn {
    opacity: 1;
  }

  
  .copy-btn.editor-copy-btn {
    right: 40px;
  }
  .copy-btn.pin-btn {
    right: 76px;
  }
  .path-cell .path-pin-btn {
    right: 4px;
    opacity: 0;
  }
  .path-cell .path-link-btn {
    right: 40px;
    opacity: 0;
  }
  .path-cell:hover .path-pin-btn,
  .path-cell:hover .path-link-btn {
    opacity: 1;
  }

  .copy-btn:hover {
    background-color: #4b5563;
    border-color: #4b5563;
    color: #fff;
  }

  table.dataTable.dtr-inline > tbody > tr > td.dtr-control:before,
  table.dataTable.dtr-inline > tbody > tr > td.details-control:before {
    content: '‚ñ∏' !important;
    left: 4px;
    right: auto;
  }
  table.dataTable.dtr-inline > tbody > tr.parent > td.dtr-control:before,
  table.dataTable.dtr-inline > tbody > tr.parent > td.details-control:before {
    content: '‚ñæ' !important;
  }

  table.dataTable.dtr-inline > tbody > tr > td.dtr-control,
  table.dataTable.dtr-inline > tbody > tr > td.details-control {
    width: 18px;
    text-align: left;
  }

  table.dataTable tbody tr.child td {
    background: var(--bg-soft);
  }
  .row-detail {
    padding: 8px 10px;
    display: grid;
    gap: 8px;
    font-size: 0.85rem;
  }
  .row-detail__title {
    font-weight: 700;
  }
  .row-detail__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .row-detail__meta {
    display: grid;
    gap: 4px;
  }
  .row-detail__image {
    width: 100%;
    max-width: 280px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg-soft);
  }
  .row-detail__action {
    border: 1px solid var(--border);
    background: var(--bg-soft);
    color: var(--text);
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 0.7rem;
  }

  
  #togglePresets {
    padding: 8px 12px;
    font-size: 0.95rem;
  }

  #togglePresets.active {
    background-color: var(--accent);
    color: #111;
    border-color: var(--accent);
  }

  
  @keyframes flash-highlight {
    0% { background-color: rgba(242, 183, 0, 0.28); }
    100% { background-color: transparent; }
  }
  .flash {
    animation: flash-highlight 1s ease-out;
  }

  #loadingIndicator {
    margin: 40px 0 8px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-align: center;
    color: var(--text);
  }

  
  #statusMessage {
    margin: 18px 0 0;
    text-align: center;
    font-weight: 500;
    font-style: italic;
    color: var(--muted);
  }

  .objects-layout {
    width: 95%;
    margin: 14px auto 0;
    display: flex;
    gap: 14px;
    align-items: flex-start;
    padding-right: 404px;
  }
  .objects-layout.sidebar-collapsed {
    padding-right: 70px;
  }

  .objects-layout #dayzObjects_wrapper {
    flex: 1;
    width: auto !important;
    margin: 0;
  }

  .object-focus {
    display: none;
    width: 390px;
    padding: 8px;
    max-width: 100%;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 4px;
    box-shadow: var(--shadow-soft);
    gap: 10px;
    flex-wrap: wrap;
    align-items: flex-start;
    position: fixed;
    top: 135px;
    right: 2.5%;
    z-index: 6;
    flex: 0 0 390px;
    align-self: flex-start;
  }
  .object-focus.visible,
  .object-focus.has-pins {
    display: flex;
  }
  .object-focus.collapsed {
    width: 52px;
    min-width: 52px;
    max-width: 52px;
    flex: 0 0 52px;
    padding: 8px 6px;
    justify-content: center;
    position: fixed;
    top: 135px;
    right: 2.5%;
    z-index: 6;
  }
  .object-focus.collapsed .object-focus__image,
  .object-focus.collapsed .object-focus__details {
    display: none;
  }
  .object-focus__pin-hint {
    display: none;
    margin-top: 6px;
    font-size: 1rem;
    color: var(--muted);
  }
  .object-focus.collapsed .object-focus__pin-hint {
    display: block;
  }

  .object-focus__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    width: 100%;
  }
  .object-focus.collapsed .object-focus__clear {
    display: none;
  }

  .object-focus__collapse {
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    border-radius: 6px;
    padding: 6px 8px;
    cursor: pointer;
    font-weight: 700;
    line-height: 1;
  }
  .object-focus__collapse:hover {
    background: var(--bg-soft);
  }

  .object-focus__clear {
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    border-radius: 6px;
    padding: 6px 8px;
    cursor: pointer;
    font-weight: 700;
    line-height: 1;
  }
  .object-focus__clear:hover {
    background: var(--bg-soft);
  }
  .object-focus__image {
    width: 100%;
    height: 260px;
    border: none;
    border-radius: 4px;
    background: var(--input-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .object-focus__image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .object-focus__missing {
    color: var(--muted);
    font-style: italic;
    text-align: center;
    padding: 0 10px;
  }
  .object-focus__details {
    flex: 1;
    min-width: 220px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .object-focus__label {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--muted);
  }
  .object-focus__name {
    font-size: clamp(1rem, 0.9rem + 0.5vw, 1.3rem);
    font-weight: 700;
    color: var(--text);
    word-break: break-word;
  }
  .object-focus__path {
    font-family: monospace;
    color: var(--muted);
    font-size: clamp(0.78rem, 0.72rem + 0.3vw, 0.92rem);
    word-break: break-word;
  }
  .object-focus__actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .object-focus__primary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 8px;
  }
  .object-focus__secondary {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .object-focus__secondary.is-right {
    justify-content: flex-end;
  }
  .object-focus__secondary .pill-button {
    font-size: 0.7rem;
    padding: 3px 6px;
  }
  .object-focus__meta {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: clamp(0.78rem, 0.72rem + 0.3vw, 0.92rem);
    color: var(--text);
  }
  .object-focus__meta span {
    color: var(--muted);
  }

  .pinned-objects {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    box-shadow: var(--shadow-soft);
    margin-bottom: 10px;
    width: 100%;
  }

  .pinned-objects.is-empty {
    display: none;
  }

  .pinned-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
  }
  .pinned-copy {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
    align-items: center;
    font-size: 0.85rem;
    color: var(--muted);
  }
  .pinned-copy__row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .pinned-copy__row--between {
    justify-content: space-between;
    width: 100%;
  }
  .pinned-copy__toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.7rem;
    color: var(--muted);
  }
  .pinned-copy__toggle input {
    accent-color: var(--accent);
  }
  .pinned-copy .pill-button {
    font-size: 0.7rem;
    padding: 3px 6px;
  }
  .pinned-copy .pill-button.copied {
    background-color: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  .pinned-title {
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    font-size: 0.75rem;
    color: var(--text);
  }

  #pinnedCopyAll {
    display: none;
  }

  #pinnedCopyAll.visible {
    display: inline-flex;
  }

  #pinnedCopyNames {
    display: none;
  }

  #pinnedCopyNames.visible {
    display: inline-flex;
  }
  #pinnedCopyLink {
    display: none;
  }
  #pinnedCopyLink.visible {
    display: inline-flex;
  }

  #pinnedCopyAllLayout,
  #pinnedBulkPanel {
    display: none;
  }

  #pinnedCopyAllLayoutRow {
    display: none;
  }

  #pinnedCopyAllLayoutRow.visible {
    display: flex;
  }

  #pinnedCopyAllLayout.visible {
    display: inline-flex;
  }

  #pinnedBulkPanel.visible {
    display: block;
  }
  #pinnedClearAll {
    display: none;
  }
  #pinnedClearAll.visible {
    display: inline-flex;
  }
  #pinnedClearAll {
    margin-left: 6px;
    color: #f87171;
    border-color: #fca5a5;
  }
  #pinnedClearAll:hover {
    color: #ef4444;
    border-color: #ef4444;
  }
  #pinnedDownloadAll {
    display: none;
  }
  #pinnedDownloadAll.visible {
    display: inline-flex;
  }

  .pinned-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .pinned-item {
    display: grid;
    grid-template-columns: 32px 1fr auto;
    align-items: center;
    gap: 6px;
    background: var(--bg-soft);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px 6px;
    cursor: pointer;
    user-select: none;
  }
  .pinned-item:hover {
    background: rgba(148, 163, 184, 0.12);
  }
  .pinned-item.expanded {
    grid-template-columns: 32px 1fr auto;
  }
  .pinned-path-panel {
    grid-column: 1 / -1;
    display: none;
    margin-top: 4px;
    padding: 6px;
    border-radius: 6px;
    background: var(--card);
    border: 1px solid var(--border);
  }
  .pinned-item.expanded .pinned-path-panel {
    display: block;
  }
  .pinned-path-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 6px;
  }
  .pinned-path-row--between {
    justify-content: space-between;
  }
  .pinned-path-row--right {
    justify-content: flex-end;
  }
  .pinned-path-row:last-child {
    margin-bottom: 0;
  }
  .pinned-path-label {
    font-size: 0.7rem;
    color: var(--muted);
  }
  .pinned-path-cta {
    font-weight: 700;
  }
  .pinned-path-btn {
    border: 1px solid var(--border);
    background: var(--bg-soft);
    color: var(--text);
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 0.7rem;
    transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
  }
  .pinned-path-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  }
  .pinned-path-btn.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  .pinned-actions {
    display: inline-flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.15s ease;
  }
  .pinned-item:hover .pinned-actions {
    opacity: 1;
  }
  .pinned-action-btn {
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    border-radius: 4px;
    padding: 2px 4px;
    cursor: pointer;
    font-size: 0.65rem;
  }
  .pinned-action-btn:hover {
    background: var(--bg-soft);
  }

  .pinned-thumb {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: var(--card);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    color: var(--muted);
    font-size: 0.6rem;
  }

  .pinned-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .pinned-name {
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .pinned-path-arrow {
    display: inline-flex;
    align-items: center;
    margin-right: 6px;
    color: var(--muted);
    font-size: 0.75rem;
  }

  .pinned-remove {
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    border-radius: 6px;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 0.7rem;
  }

  .pinned-remove:hover {
    background: var(--bg-soft);
  }
  .pinned-remove-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-size: 0.75rem;
    cursor: pointer;
  }
  .pinned-remove-link:hover {
    background: var(--bg-soft);
  }

  .object-focus.focus-empty .object-focus__image,
  .object-focus.focus-empty .object-focus__details {
    display: none;
  }
  .object-focus.empty-state .object-focus__image,
  .object-focus.empty-state .object-focus__actions {
    display: none;
  }
  .object-focus.no-selection .object-focus__actions {
    display: none;
  }
  .object-focus.empty-state .object-focus__details > :not(.object-focus__empty) {
    display: none;
  }
  .object-focus__empty {
    display: none;
    font-size: 0.9rem;
    color: var(--muted);
    text-align: center;
    padding: 16px 8px;
  }
  .object-focus.empty-state .object-focus__empty {
    display: block;
  }

  .object-focus.collapsed .pinned-objects {
    width: 100%;
    padding: 4px;
    border: none;
    box-shadow: none;
    background: transparent;
  }

  .object-focus.collapsed .pinned-header {
    display: none;
  }

  .object-focus.collapsed .pinned-list {
    gap: 6px;
    align-items: center;
  }

  .object-focus.collapsed .pinned-item {
    grid-template-columns: 1fr;
    padding: 0;
    border: none;
    background: transparent;
    cursor: pointer;
    justify-items: center;
  }
  .object-focus.collapsed .pinned-actions {
    display: none;
  }
  .object-focus.collapsed .pinned-path-panel {
    display: none;
  }
  .object-focus.collapsed .pinned-thumb {
    width: 36px;
    height: 36px;
  }

  .object-focus.collapsed .pinned-name,
  .object-focus.collapsed .pinned-remove {
    display: none;
  }

  @media (max-width: 1100px) {
    .objects-layout {
      flex-direction: column;
      padding-right: 0;
    }
    .object-focus {
      width: 100%;
      position: sticky;
      top: auto;
      order: 2;
    }
    .objects-layout #dayzObjects_wrapper {
      order: 1;
      width: 100% !important;
    }
    .objects-layout.sidebar-collapsed {
      padding-right: 0;
    }
    .object-focus.collapsed {
      display: none !important;
    }
  }
  @media (max-width: 768px) {
    .object-focus__image {
      width: 100%;
      height: 220px;
    }
    .object-focus__details {
      width: 100%;
    }
  }

  #imgPreview img {
    max-width: 400px;
    max-height: 400px;
    display: block;
    border-radius: 3px;
  }

  .export-panel {
    display: none;
    width: 100%;
    margin-top: 10px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--card);
    box-shadow: var(--shadow-soft);
  }
  .export-panel.is-open {
    display: block;
  }
  .export-panel__intro {
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
  }
  .export-panel__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
  }
  .export-panel__suggestions {
    margin-bottom: 10px;
    color: var(--text);
  }
  .export-panel__suggestions ul {
    margin: 6px 0 0 18px;
  }
  .export-panel__images {
    color: var(--text);
  }
</style>

<div id="filters">
  <label for="filterCategory">Category:</label>
  <select id="filterCategory">
    <option value="">All</option>
  </select>

  <label for="filterConsole">Usable on Console:</label>
  <select id="filterConsole">
    <option value="">All</option>
    <option value="‚úÖ">Yes</option>
    <option value="‚ùå">No</option>
  </select>
  <button id="resetFilters" class="pill-button" type="button">Reset filters</button>

  <div class="filter-actions">
    <button id="togglePresets" class="pill-button" type="button">Show presets</button>
    <button id="exportToggle" class="pill-button" type="button" aria-expanded="false" aria-controls="exportPanel">Export data</button>
    <button id="themeToggle" class="pill-button theme-toggle" type="button" aria-live="polite">
      Dark mode
    </button>
  </div>

  <div id="exportPanel" class="export-panel" aria-hidden="true">
    <div class="export-panel__intro">Export the current filtered view (images excluded).</div>
    <div class="export-panel__actions">
      <button id="exportCsv" class="pill-button" type="button">Download CSV</button>
      <button id="exportXlsx" class="pill-button" type="button">Download XLSX</button>
      <button id="exportJson" class="pill-button" type="button">Download JSON</button>
    </div>
    <div class="export-panel__images">
      Want all the images? <a href="https://drive.google.com/drive/folders/1Hg82OAu-Br5VPSF4NxGvifG_IeF6Iw-u?usp=share_link" target="_blank" rel="noopener">Download here.</a>
    </div>
  </div>
</div>

<div id="loadingIndicator">
  Loading {{ $objectCount }} objects...
</div>

<div id="statusMessage"></div>

<div class="objects-layout">
  <table id="dayzObjects" class="display nowrap" style="width:100%">
    <thead>
      <tr>
        <th></th>
        <th aria-label="Thumbnail"></th>
        <th>Class name</th>
        <th>In-game name</th>
        <th>Category</th>
        <th>Path</th>
        <th>Console</th>
        <th>Type</th>
        <th>Search Tags</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <div id="objectFocus" class="object-focus" aria-live="polite">
    <div class="object-focus__pin-hint" aria-hidden="true">üìå</div>
    <div class="object-focus__header">
      <button id="objectFocusCollapse" class="object-focus__collapse" type="button" aria-label="Collapse sidebar">&gt;&gt;</button>
      <button id="objectFocusClear" class="object-focus__clear" type="button" aria-label="Deselect object" title="Deselect object">üÜá</button>
    </div>
    <div class="object-focus__image" id="objectFocusImage">
      <span class="object-focus__missing">Select an object to preview its image.</span>
    </div>
    <div class="object-focus__details">
      <div id="objectFocusName" class="object-focus__name"></div>
      <div id="objectFocusEmpty" class="object-focus__empty">You can select or pin objects in this menu.</div>
      <div class="object-focus__actions">
        <div class="object-focus__secondary">
          <button id="objectFocusPin" class="pill-button" type="button">üìå Pin</button>
          <button id="objectFocusCopy" class="pill-button" type="button">üîó Copy link</button>
          <button id="objectFocusEditor" class="pill-button" type="button">üèóÔ∏è Copy to Editor</button>
          <button id="objectFocusNameCopy" class="pill-button" type="button">üìã Copy name</button>
        </div>
      </div>
      <div id="objectFocusPath" class="object-focus__path"></div>
      <div class="object-focus__meta" id="objectFocusMeta"></div>
      <div class="object-focus__actions">
        <div class="object-focus__secondary is-right">
          <a id="objectFocusLink" class="pill-button" href="#" download>‚Üì Download image</a>
          <a id="objectFocusTypesLink" class="pill-button" href="#" download>‚Üì Download types entry</a>
        </div>
      </div>
    </div>
    <div id="pinnedObjects" class="pinned-objects is-empty" aria-live="polite">
      <div class="pinned-header">
        <div class="pinned-copy">
          <div id="pinnedCopyAllLayoutRow" class="pinned-copy__row pinned-copy__row--between">
            <span class="pinned-title">Pinned</span>
            <div class="pinned-copy__row">
              <span>Copy all:</span>
              <button id="pinnedCopyAll" class="pill-button" type="button" title="Copy all to Editor">üèóÔ∏è</button>
              <button id="pinnedCopyNames" class="pill-button" type="button" title="Copy all names">üìã</button>
              <button id="pinnedCopyLink" class="pill-button" type="button" title="Copy link to pinned collection">üîó</button>
            </div>
          </div>
          <div class="pinned-copy__row">
            <button id="pinnedCopyAllLayout" class="pill-button" type="button" title="Copy pinned objects with layout">Copy to Editor as...</button>
            <button id="pinnedDownloadAll" class="pill-button" type="button" title="Download all">‚Üì Download all</button>
            <button id="pinnedClearAll" class="pill-button" type="button" title="Unpin all">Unpin all</button>
          </div>
          <div id="pinnedBulkPanel" class="pinned-path-panel pinned-bulk-panel">
            <div class="pinned-path-row">
              <span class="pinned-path-label">Layout:</span>
              <button class="pinned-path-btn pinned-bulk-layout" type="button" data-layout="grid">As grid</button>
              <button class="pinned-path-btn pinned-bulk-layout" type="button" data-layout="line">In line</button>
              <button class="pinned-path-btn pinned-bulk-layout" type="button" data-layout="stacked">Stacked</button>
            </div>
            <div class="pinned-path-row">
              <span class="pinned-path-label">Spacing:</span>
              <button class="pinned-path-btn pinned-bulk-spacing" type="button" data-spacing="small">Small (1m)</button>
              <button class="pinned-path-btn pinned-bulk-spacing" type="button" data-spacing="medium">Medium (5m)</button>
              <button class="pinned-path-btn pinned-bulk-spacing" type="button" data-spacing="large">Large (10m)</button>
              <button class="pinned-path-btn pinned-bulk-spacing" type="button" data-spacing="huge">Huge (25m)</button>
            </div>
            <div class="pinned-path-row">
              <label class="pinned-copy__toggle" for="pinnedIncludePaths">
                <input id="pinnedIncludePaths" type="checkbox">
                Include paths?
              </label>
            </div>
            <div class="pinned-path-row pinned-path-row--right">
              <button id="pinnedBulkCopyConfirm" class="pinned-path-btn pinned-path-cta" type="button">Copy now</button>
            </div>
          </div>
        </div>
      </div>
      <div id="pinnedList" class="pinned-list"></div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
  var statusMessages = [
    'This project is a work in progress - add feedback on the Discord',
	'There are more than 190 hats in DayZ - Sam‚Äôs favourite is the Zimikova',
	'The only P3Ds you can use on console are rocks and plants',
	'Working on console? Filter by console and look for the ‚úÖ mark',
	'You can copy and paste directly into DayZ Editor using the üèóÔ∏è button',
	'DayZ uses the scientific names for plants and animals - but you can just search for "birch" or "wolf"',
	'There are more than 60 different types of birch tree in DayZ',
	'There are more than 40 different types of armbands in DayZ',
	'The most annoying type of object to categorise was railway tracks',
	'There are several invisible ghost assets used for development - they may also be haunted',
	'There are nine types of mushroom in DayZ',
	'There are 31 different playable Survivors in DayZ',
	'You can add size and colour to your searches for large rocks or green bags',
	'Notice an error? Well done, you get a gold star. Report it on the Discord',
	'Sam spent too long categorising fences',
	'If you keep refreshing the page, you will eventually see all these messages',
	'Put your credit card into this website to unlock the object list WITHOUT the errors',
	'There are more than 90 different types of spruce tree in DayZ',
	'There are 45 different houses in DayZ - each has been tagged with its callouts',
	'This loading message hides many sins'
  ];
  (function() {
    var statusMessageEl = document.getElementById('statusMessage');
    if (!statusMessageEl) return;
    statusMessageEl.textContent = statusMessages[Math.floor(Math.random() * statusMessages.length)];
    statusMessageEl.style.display = 'block';
  })();

  $(document).ready(function() {
    var statusMessageEl = document.getElementById('statusMessage');
    var $tableEl = $('#dayzObjects');
    $('#filters').hide();

    var escapeRegex = function(value) {
      return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    };
    var escapeHtml = function(value) {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };
    var getObjectName = function(row) {
      return row.objectName || row.name || row.Name || '';
    };
    var getConsoleFlag = function(row) {
      return row.usableOnConsole ? '‚úÖ' : '‚ùå';
    };
    var getSearchTags = function(row) {
      return row.searchTags || '';
    };

    var showContent = function() {
      $('#dayzObjects, #dayzObjects_wrapper').css('visibility', 'visible');
      $('#loadingIndicator').hide();
      $('#filters').css('display', 'flex');
      if (statusMessageEl) {
        statusMessageEl.style.display = 'none';
      }
    };
    
    $tableEl.one('init.dt', showContent);

    var table = $tableEl.DataTable({
      ajax: {
        url: '/data/dayz_objects.json',
        dataSrc: ''
      },
      deferRender: true,
      responsive: {
        breakpoints: [
          { name: 'wide', width: 1360 },
          { name: 'desktop', width: 1133 },
          { name: 'tablet', width: 744 },
          { name: 'mobile', width: 0 }
        ],
        details: {
          type: 'column',
          target: 0,
          renderer: function(api, rowIdx) {
            var $cell = $(api.row(rowIdx).node()).find('.object-name-cell');
            return buildRowDetailsHtml($cell);
          }
        }
      },
      pageLength: 50,
      lengthMenu: [[50,100,200,500],[50,100,200,500]],
      columns: [
        { data: null, defaultContent: '' },
        {
          data: null,
          render: function(data, type, row) {
            if (type !== 'display') return row.image || '';
            if (row.image) {
              var safeImg = escapeHtml(row.image);
              var safeName = escapeHtml(getObjectName(row));
              return '<img class="thumb-img" src="/' + safeImg + '" alt="' + safeName + ' thumbnail" loading="lazy">';
            }
            return '<span class="thumb-fallback">‚Äî</span>';
          }
        },
        {
          data: null,
          render: function(data, type, row) {
            var objName = getObjectName(row);
            if (type !== 'display') return objName;
            var consoleFlag = getConsoleFlag(row);
            var editorJson = row.editorJson ? JSON.stringify(row.editorJson) : '';
            return (
              escapeHtml(objName) +
              '<button class="copy-btn pin-btn" title="Pin object">üìå</button>' +
              '<button class="copy-btn" title="Copy object name">üìã</button>' +
              '<button class="copy-btn editor-copy-btn" title="Copy DayZ Editor JSON">üèóÔ∏è</button>'
            );
          }
        },
        { data: 'inGameName', defaultContent: '' },
        { data: 'category', defaultContent: '' },
        {
          data: null,
          render: function(data, type, row) {
            var pathValue = row.path || '';
            if (type !== 'display') return pathValue;
            var safePath = escapeHtml(pathValue);
            var buttons = '';
            if (pathValue && pathValue !== '-') {
              buttons = (
                '<button class="copy-btn path-link-btn" title="Copy link to path">üîó</button>' +
                '<button class="copy-btn path-pin-btn" title="Pin path">üìå</button>'
              );
            }
            return safePath + buttons;
          }
        },
        {
          data: null,
          render: function(data, type, row) {
            var flag = getConsoleFlag(row);
            if (type !== 'display') return flag;
            return flag;
          }
        },
        { data: 'modelType', defaultContent: '' },
        {
          data: null,
          render: function(data, type, row) {
            return type === 'display' ? escapeHtml(getSearchTags(row)) : getSearchTags(row);
          }
        }
      ],
      columnDefs: [
        { targets: 0, orderable: false, className: 'dtr-control min-desktop' },
        { targets: 1, orderable: false, className: 'all thumb-cell' },
        {
          targets: 2,
          className: 'all object-name-cell',
          createdCell: function(td, cellData, rowData) {
            var objName = getObjectName(rowData);
            var consoleFlag = getConsoleFlag(rowData);
            var editorJson = rowData.editorJson ? JSON.stringify(rowData.editorJson) : '';
            td.setAttribute('data-object', objName);
            td.setAttribute('data-p3d', rowData.path || '');
            td.setAttribute('data-modeltype', rowData.modelType || '');
            td.setAttribute('data-ingame', rowData.inGameName || '');
            td.setAttribute('data-category', rowData.category || '');
            td.setAttribute('data-console', consoleFlag);
            td.setAttribute('data-tags', getSearchTags(rowData));
            td.setAttribute('data-image', rowData.image || '');
            td.setAttribute('data-editorjson', editorJson);
          }
        },
        { targets: 3, className: 'min-desktop' },
        { targets: 4, className: 'min-desktop' },
        { targets: 5, className: 'min-desktop path-cell' },
        { targets: 6, className: 'min-wide' },
        { targets: 7, className: 'min-wide' },
        { targets: 8, className: 'min-wide' }
      ],
      dom: '<"top-bar"lfr>tip',
      language: {
        search: "Search: ",
        searchPlaceholder: "'large snow rock', '308 rifles'"
      }
    });
    
    if (table.settings()[0]._bInitComplete) {
      showContent();
    }
   
    $("#filters").insertBefore("#dayzObjects_wrapper .top-bar");

    $tableEl.addClass('dtr-column');
    $(window).on('resize', function() {
      if (table) {
        table.columns.adjust();
        table.responsive.recalc();
      }
    });

    var logoLink = document.querySelector('nav a');
    if (logoLink) {
      logoLink.addEventListener('click', function() {
        if (table) {
          table.search('').columns().search('').draw();
        }
        hideFocusDetails();
      });
    }

    var objectFocusEl = document.getElementById('objectFocus');
    var objectsLayoutEl = document.querySelector('.objects-layout');
    var objectFocusNameEl = document.getElementById('objectFocusName');
    var objectFocusPathEl = document.getElementById('objectFocusPath');
    var objectFocusImageEl = document.getElementById('objectFocusImage');
    var objectFocusLinkEl = document.getElementById('objectFocusLink');
    var objectFocusTypesLinkEl = document.getElementById('objectFocusTypesLink');
    var objectFocusClearEl = document.getElementById('objectFocusClear');
    var objectFocusCopyEl = document.getElementById('objectFocusCopy');
    var objectFocusEditorEl = document.getElementById('objectFocusEditor');
    var objectFocusNameCopyEl = document.getElementById('objectFocusNameCopy');
    var objectFocusMetaEl = document.getElementById('objectFocusMeta');
    var objectFocusEmptyEl = document.getElementById('objectFocusEmpty');
    var currentObjectName = null;
    var currentObjectData = null;
    var currentObjectRowEl = null;
    var typesEntryUrl = null;
    var typesEntryByName = {};
    var pinnedObjectsEl = document.getElementById('pinnedObjects');
    var pinnedListEl = document.getElementById('pinnedList');
    var pinnedClearAllEl = document.getElementById('pinnedClearAll');
    var pinnedCopyAllEl = document.getElementById('pinnedCopyAll');
    var pinnedCopyAllLayoutEl = document.getElementById('pinnedCopyAllLayout');
    var pinnedCopyAllLayoutRowEl = document.getElementById('pinnedCopyAllLayoutRow');
    var pinnedCopyNamesEl = document.getElementById('pinnedCopyNames');
    var pinnedCopyLinkEl = document.getElementById('pinnedCopyLink');
    var pinnedDownloadAllEl = document.getElementById('pinnedDownloadAll');
    var pinnedIncludePathsEl = document.getElementById('pinnedIncludePaths');
    var pinnedBulkPanelEl = document.getElementById('pinnedBulkPanel');
    var pinnedBulkCopyConfirmEl = document.getElementById('pinnedBulkCopyConfirm');
    var pinnedBulkLayoutButtons = document.querySelectorAll('.pinned-bulk-layout');
    var pinnedBulkSpacingButtons = document.querySelectorAll('.pinned-bulk-spacing');
    var isMobileView = window.matchMedia('(max-width: 768px)').matches;
    var objectFocusPinEl = document.getElementById('objectFocusPin');
    var objectFocusCollapseEl = document.getElementById('objectFocusCollapse');
    var pinnedItems = [];
    var isPinned = function(objName) {
      return pinnedItems.some(function(item) { return item.objName === objName; });
    };
    var updateCollapseButtonLabel = function() {
      if (!objectFocusCollapseEl || !objectFocusEl) return;
      var isCollapsed = objectFocusEl.classList.contains('collapsed');
      objectFocusCollapseEl.textContent = isCollapsed ? '>>' : '<<';
      objectFocusCollapseEl.setAttribute('aria-label', isCollapsed ? 'Expand sidebar' : 'Collapse sidebar');
    };
    var updateEmptyState = function() {
      if (!objectFocusEl || !objectFocusEmptyEl) return;
      var hasSelection = Boolean(currentObjectName);
      var isCollapsed = objectFocusEl.classList.contains('collapsed');
      objectFocusEl.classList.toggle('empty-state', !hasSelection && !isCollapsed);
      objectFocusEl.classList.toggle('no-selection', !hasSelection);
    };
    var updateLayoutForSidebar = function() {
      if (!objectsLayoutEl || !objectFocusEl) return;
      objectsLayoutEl.classList.toggle('sidebar-collapsed', objectFocusEl.classList.contains('collapsed'));
    };
    var updateMobileView = function() {
      isMobileView = window.matchMedia('(max-width: 768px)').matches;
      if (isMobileView) {
        $('#imgPreview').remove();
      }
    };

    var setTypesEntry = function(objName) {
      if (!objectFocusTypesLinkEl) return;
      if (typesEntryUrl) {
        URL.revokeObjectURL(typesEntryUrl);
        typesEntryUrl = null;
      }
      if (!objName) {
        objectFocusTypesLinkEl.style.display = 'none';
        objectFocusTypesLinkEl.removeAttribute('download');
        return;
      }
      var entry = typesEntryByName[objName];
      if (!entry) {
        objectFocusTypesLinkEl.style.display = 'none';
        objectFocusTypesLinkEl.removeAttribute('download');
        return;
      }
      var blob = new Blob([entry + '\n'], { type: 'application/xml;charset=utf-8' });
      typesEntryUrl = URL.createObjectURL(blob);
      objectFocusTypesLinkEl.href = typesEntryUrl;
      objectFocusTypesLinkEl.setAttribute('download', objName + '.xml');
      objectFocusTypesLinkEl.style.display = 'inline-flex';
    };

    if (objectFocusEl) {
      objectFocusEl.classList.add('visible', 'collapsed');
      updateCollapseButtonLabel();
      updateEmptyState();
      updateLayoutForSidebar();
    }
    window.addEventListener('resize', updateMobileView);
    updateMobileView();

    var buildRowDetailsHtml = function($cell) {
      var objName = $cell.data('object') || '';
      var imgPath = $cell.data('image') || '';
      var p3dPath = $cell.data('p3d') || '';
      var inGame = $cell.data('ingame') || '';
      var category = $cell.data('category') || '';
      var modelType = $cell.data('modeltype') || '';
      var consoleFlag = $cell.data('console') || '';
      var tags = $cell.data('tags') || '';
      var imgHtml = imgPath ? '<img class="row-detail__image" src="/' + escapeHtml(imgPath) + '" alt="' + escapeHtml(objName) + ' preview">' : '';
      return (
        '<div class="row-detail" data-object="' + escapeHtml(objName) + '">' +
          '<div class="row-detail__title">' + escapeHtml(objName) + '</div>' +
          '<div class="row-detail__actions">' +
            '<button class="row-detail__action" data-action="pin">üìå Pin</button>' +
            '<button class="row-detail__action" data-action="link">üîó Copy link</button>' +
            '<button class="row-detail__action" data-action="editor">üèóÔ∏è Copy to Editor</button>' +
            '<button class="row-detail__action" data-action="name">üìã Copy name</button>' +
          '</div>' +
          (imgHtml ? imgHtml : '') +
          '<div class="row-detail__meta">' +
            '<div>Path: ' + escapeHtml(p3dPath || '‚Äî') + '</div>' +
            '<div>In-game name: ' + escapeHtml(inGame || '‚Äî') + '</div>' +
            '<div>Category: ' + escapeHtml(category || '‚Äî') + '</div>' +
            '<div>Model type: ' + escapeHtml(modelType || '‚Äî') + '</div>' +
            '<div>Console: ' + escapeHtml(consoleFlag || '‚Äî') + '</div>' +
            '<div>Tags: ' + escapeHtml(tags || '‚Äî') + '</div>' +
          '</div>' +
          '<div class="row-detail__actions">' +
            (imgPath ? '<a class="row-detail__action" data-action="download" href="/' + escapeHtml(imgPath) + '" download>‚Üì Download image</a>' : '') +
            '<button class="row-detail__action" data-action="close">üÜá Deselect object</button>' +
          '</div>' +
        '</div>'
      );
    };

    var buildObjectUrl = function(objName) {
      var nextUrl = new URL(window.location);
      if (objName) {
        nextUrl.searchParams.set('object', objName);
      } else {
        nextUrl.searchParams.delete('object');
      }
      return nextUrl.toString();
    };
    var buildPinnedUrl = function(names) {
      var nextUrl = new URL(window.location);
      if (Array.isArray(names) && names.length) {
        nextUrl.searchParams.set('pinned', names.join('|'));
      } else {
        nextUrl.searchParams.delete('pinned');
      }
      nextUrl.searchParams.delete('object');
      return nextUrl.toString();
    };

    var buildEditorJson = function(editorJsonRaw, objName, modelType, p3dPath) {
      if (editorJsonRaw && editorJsonRaw.trim() !== "") {
        try {
          var parsed = JSON.parse(editorJsonRaw);
          return JSON.stringify(parsed, null, 4);
        } catch (err) {
          console.error("Invalid editorJson for row:", err);
        }
      }

      var typeValue = (modelType === "Config")
        ? objName
        : p3dPath.replace(/\//g, "\\") + "\\" + objName;

      var json = [{
        Type: typeValue,
        DisplayName: "",
        Position: [0, 0, 0],
        Orientation: [0, 0, 0],
        Scale: 1.0,
        AttachmentMap: {},
        Model: "",
        Flags: 30,
        m_LowBits: 0,
        m_HighBits: 0
      }];

      return JSON.stringify(json, null, 4);
    };

    var hideFocusDetails = function() {
      if (objectFocusEl) {
        objectFocusEl.classList.add('visible');
        objectFocusEl.classList.remove('focus-empty');
      }
      if (objectFocusNameEl) {
        objectFocusNameEl.textContent = '';
      }
      if (objectFocusPathEl) {
        objectFocusPathEl.textContent = '';
      }
      if (objectFocusMetaEl) {
        objectFocusMetaEl.innerHTML = '';
      }
      if (objectFocusImageEl) {
        objectFocusImageEl.innerHTML =
          '<span class="object-focus__missing">Select an object to preview its image.</span>';
      }
      if (objectFocusLinkEl) {
        objectFocusLinkEl.style.display = 'none';
        objectFocusLinkEl.removeAttribute('download');
      }
      if (objectFocusTypesLinkEl) {
        objectFocusTypesLinkEl.style.display = 'none';
        objectFocusTypesLinkEl.removeAttribute('download');
      }
      currentObjectName = null;
      currentObjectData = null;
      if (currentObjectRowEl) {
        currentObjectRowEl.classList.remove('object-selected');
        currentObjectRowEl = null;
      }
      updateEmptyState();
    };

    var setObjectFocusData = function(objData, updateUrl) {
      if (!objectFocusEl || !objData) return;
      objectFocusEl.classList.remove('collapsed');
      objectFocusEl.classList.add('expanded');
      objectFocusEl.classList.remove('focus-empty');
      updateLayoutForSidebar();
      var objName = objData.objName || '';
      var imgPath = objData.imgPath;
      var p3dPath = objData.p3dPath;
      var modelType = objData.modelType;
      var category = objData.category;
      var inGame = objData.inGame;
      var consoleFlag = objData.consoleFlag;
      var tags = objData.tags;
      var editorJsonRaw = objData.editorJsonRaw;

      currentObjectName = objName;
      currentObjectData = {
        objName: objName,
        imgPath: imgPath,
        p3dPath: p3dPath,
        modelType: modelType,
        editorJsonRaw: editorJsonRaw,
        category: category,
        inGame: inGame,
        consoleFlag: consoleFlag,
        tags: tags
      };
      objectFocusNameEl.textContent = objName;
      objectFocusPathEl.textContent = p3dPath ? ('Path: ' + p3dPath) : '';
      if (objectFocusMetaEl) {
        objectFocusMetaEl.innerHTML =
          '<div><span>In-game name:</span> ' + (inGame || '‚Äî') + '</div>' +
          '<div><span>Category:</span> ' + (category || '‚Äî') + '</div>' +
          '<div><span>Model type:</span> ' + (modelType || '‚Äî') + '</div>' +
          '<div><span>Console:</span> ' + (consoleFlag || '‚Äî') + '</div>' +
          '<div><span>Tags:</span> ' + (tags || '‚Äî') + '</div>';
      }

      if (imgPath) {
        objectFocusImageEl.innerHTML =
          '<img src="/' + imgPath + '" alt="' + objName + ' preview">';
        objectFocusLinkEl.href = '/' + imgPath;
        objectFocusLinkEl.setAttribute('download', objName ? (objName + '.png') : '');
        objectFocusLinkEl.style.display = 'inline-flex';
      } else {
        objectFocusImageEl.innerHTML =
          '<span class="object-focus__missing">No image available for this object.</span>';
        objectFocusLinkEl.style.display = 'none';
      }
      setTypesEntry(objName);

      objectFocusEl.classList.add('visible');
      if (objectFocusPinEl) {
        objectFocusPinEl.textContent = isPinned(objName) ? 'üìå Unpin' : 'üìå Pin';
      }
      updateEmptyState();

      if (updateUrl && objName) {
        history.replaceState({}, '', buildObjectUrl(objName));
      }
    };

    fetch('/data/types_aggregated.xml')
      .then(function(resp) { return resp.ok ? resp.text() : ''; })
      .then(function(text) {
        if (!text) return;
        var parser = new DOMParser();
        var xml = parser.parseFromString(text, 'application/xml');
        var nodes = xml.getElementsByTagName('type');
        for (var i = 0; i < nodes.length; i++) {
          var node = nodes[i];
          var nameAttr = node.getAttribute('name');
          if (!nameAttr) continue;
          typesEntryByName[nameAttr] = node.outerHTML;
        }
      })
      .catch(function() {});

    var buildPinnedItemFromCell = function($td) {
      return {
        type: 'object',
        objName: $td.data('object') || '',
        imgPath: $td.data('image'),
        p3dPath: $td.data('p3d'),
        modelType: $td.data('modeltype'),
        editorJsonRaw: $td.attr('data-editorjson'),
        category: $td.data('category'),
        inGame: $td.data('ingame'),
        consoleFlag: $td.data('console'),
        tags: $td.data('tags')
      };
    };
    var buildPinnedItemFromData = function(rowData) {
      if (!rowData) return null;
      var objName = getObjectName(rowData);
      if (!objName) return null;
      return {
        type: 'object',
        objName: objName,
        imgPath: rowData.image || '',
        p3dPath: rowData.path || '',
        modelType: rowData.modelType || '',
        editorJsonRaw: rowData.editorJson ? JSON.stringify(rowData.editorJson) : '',
        category: rowData.category || '',
        inGame: rowData.inGameName || '',
        consoleFlag: getConsoleFlag(rowData),
        tags: rowData.searchTags || ''
      };
    };

    var buildPinnedItemFromRow = function(rowEl) {
      var cell = rowEl ? rowEl.querySelector('.object-name-cell') : null;
      if (!cell) return null;
      return buildPinnedItemFromCell($(cell));
    };

    var addPinnedItem = function(item) {
      if (!item || !item.objName) return;
      var exists = isPinned(item.objName);
      if (exists) return;
      pinnedItems.push(item);
      updatePinnedUI();
    };

    var addPinnedPathItem = function(pathValue, rows) {
      if (!pathValue) return;
      var exists = pinnedItems.some(function(item) {
        return item.type === 'path' && item.p3dPath === pathValue;
      });
      if (exists) {
        pinnedItems = pinnedItems.filter(function(item) {
          return item.type !== 'path' || item.p3dPath !== pathValue;
        });
        updatePinnedUI();
        return;
      }
      var items = rows.map(function(rowEl) {
        var item = buildPinnedItemFromRow(rowEl);
        if (item) {
          item.sourcePath = pathValue;
        }
        return item;
      }).filter(Boolean);
      pinnedItems.push({
        type: 'path',
        objName: pathValue,
        p3dPath: pathValue,
        items: items,
        count: items.length,
        layout: 'line',
        spacing: 5,
        mode: 'P3D',
        expanded: false
      });
      updatePinnedUI();
    };

    var removePinnedItemByName = function(objName) {
      if (!objName) return;
      pinnedItems = pinnedItems.filter(function(item) {
        if (item.type === 'path') {
          return item.p3dPath !== objName && item.objName !== objName;
        }
        return item.objName !== objName;
      });
      updatePinnedUI();
    };

    var getPinnedEntries = function() {
      var entries = [];
      pinnedItems.forEach(function(item) {
        if (item.type === 'path') {
          if (Array.isArray(item.items)) {
            entries = entries.concat(item.items);
          }
        } else {
          entries.push(item);
        }
      });
      return entries;
    };
    var getPinnedObjectEntries = function(includePaths) {
      var entries = [];
      pinnedItems.forEach(function(item) {
        if (item.type === 'path') {
          if (includePaths && Array.isArray(item.items)) {
            entries = entries.concat(item.items);
          }
        } else {
          entries.push(item);
        }
      });
      return entries;
    };

    var savePinnedItems = function() {
      try {
        localStorage.setItem('dayzPinnedObjects', JSON.stringify(pinnedItems));
      } catch (err) {
        console.warn('Unable to save pinned objects:', err);
      }
    };

    var loadPinnedItems = function() {
      try {
        var stored = localStorage.getItem('dayzPinnedObjects');
        if (!stored) return [];
        var parsed = JSON.parse(stored);
        return Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        console.warn('Unable to load pinned objects:', err);
        return [];
      }
    };

    var getSpacingValue = function(label) {
      if (label === 'small') return 1;
      if (label === 'medium') return 5;
      if (label === 'large') return 10;
      if (label === 'huge') return 25;
      return 5;
    };

    var updatePinnedUI = function() {
      if (!pinnedObjectsEl || !pinnedListEl || !objectFocusEl) return;
      pinnedListEl.innerHTML = '';

      pinnedItems.forEach(function(item) {
        if (item.type === 'path' && !item.count && Array.isArray(item.items)) {
          item.count = item.items.length;
        }
        var wrapper = document.createElement('div');
        wrapper.className = 'pinned-item';
        wrapper.setAttribute('data-object', item.objName || '');

        var thumb = document.createElement('div');
        thumb.className = 'pinned-thumb';
        if (item.imgPath && item.type !== 'path') {
          var img = document.createElement('img');
          img.src = '/' + item.imgPath;
          img.alt = (item.objName || 'Object') + ' preview';
          thumb.appendChild(img);
        } else {
          thumb.textContent = item.type === 'path' ? 'Path' : 'No image';
        }

        var name = document.createElement('div');
        name.className = 'pinned-name';
        if (item.type === 'path') {
          var pathLabel = (item.p3dPath || item.objName || 'Path') + ' (' + (item.count || 0) + ' objects)';
          var arrow = document.createElement('span');
          arrow.className = 'pinned-path-arrow';
          arrow.textContent = item.expanded ? '‚ñæ' : '‚ñ∏';
          name.appendChild(arrow);
          name.appendChild(document.createTextNode(pathLabel));
        } else {
          name.textContent = item.objName || 'Unknown';
        }

        var actions = document.createElement('div');
        actions.className = 'pinned-actions';

        var removeBtn = document.createElement('button');
        removeBtn.className = 'pinned-remove';
        removeBtn.type = 'button';
        removeBtn.textContent = 'üÜá';
        removeBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          pinnedItems = pinnedItems.filter(function(pinned) {
            if (item.type === 'path') {
              return pinned.type !== 'path' || pinned.p3dPath !== item.p3dPath;
            }
            return pinned.objName !== item.objName;
          });
          updatePinnedUI();
        });

        if (item.type === 'path') {
          var linkBadge = document.createElement('button');
          linkBadge.className = 'pinned-remove-link';
          linkBadge.type = 'button';
          linkBadge.title = 'Copy link to this path';
          linkBadge.textContent = 'üîó';
          linkBadge.addEventListener('click', function(e) {
            e.stopPropagation();
            if (!Array.isArray(item.items) || !item.items.length) return;
            var names = item.items.map(function(entry) { return entry.objName; }).filter(Boolean);
            if (!names.length) return;
            navigator.clipboard.writeText(buildPinnedUrl(names));
            var original = linkBadge.textContent;
            linkBadge.textContent = '‚úî';
            setTimeout(function() { linkBadge.textContent = original; }, 900);
          });
          actions.appendChild(linkBadge);
        }

        if (item.type !== 'path') {
          var editorBtn = document.createElement('button');
          editorBtn.className = 'pinned-action-btn';
          editorBtn.type = 'button';
          editorBtn.title = 'Copy to Editor';
          editorBtn.textContent = 'üèóÔ∏è';
          editorBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            var jsonText = buildEditorJson(
              item.editorJsonRaw,
              item.objName,
              item.modelType,
              item.p3dPath
            );
            navigator.clipboard.writeText(jsonText);
            var original = editorBtn.textContent;
            editorBtn.textContent = '‚úî';
            setTimeout(function() { editorBtn.textContent = original; }, 900);
          });

          var nameBtn = document.createElement('button');
          nameBtn.className = 'pinned-action-btn';
          nameBtn.type = 'button';
          nameBtn.title = 'Copy name';
          nameBtn.textContent = 'üìã';
          nameBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (!item.objName) return;
            navigator.clipboard.writeText(item.objName);
            var original = nameBtn.textContent;
            nameBtn.textContent = '‚úî';
            setTimeout(function() { nameBtn.textContent = original; }, 900);
          });

          actions.appendChild(editorBtn);
          actions.appendChild(nameBtn);
        }

        wrapper.addEventListener('click', function(e) {
          if (e.target.closest('.pinned-remove')) return;
          if (objectFocusEl && objectFocusEl.classList.contains('collapsed')) {
            objectFocusEl.classList.remove('collapsed');
            updateCollapseButtonLabel();
            updateEmptyState();
          }
          if (item.type === 'path') {
            item.expanded = !item.expanded;
            updatePinnedUI();
            return;
          }
          if (objectFocusEl && objectFocusEl.classList.contains('visible') && currentObjectName === item.objName) {
            hideFocusDetails();
            return;
          }
          setObjectFocusData({
            objName: item.objName,
            imgPath: item.imgPath,
            p3dPath: item.p3dPath,
            modelType: item.modelType,
            editorJsonRaw: item.editorJsonRaw,
            category: item.category,
            inGame: item.inGame,
            consoleFlag: item.consoleFlag,
            tags: item.tags
          }, false);
        });

        wrapper.appendChild(thumb);
        actions.appendChild(removeBtn);
        wrapper.appendChild(name);
        wrapper.appendChild(actions);

        if (item.type === 'path') {
          wrapper.classList.toggle('expanded', !!item.expanded);

          var panel = document.createElement('div');
          panel.className = 'pinned-path-panel';

          var rowActions = document.createElement('div');
          rowActions.className = 'pinned-path-row pinned-path-row--between';
          var copyBtn = document.createElement('button');
          copyBtn.className = 'pinned-path-btn pinned-path-cta';
          copyBtn.textContent = 'üèóÔ∏è Copy to Editor';
          copyBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            copyPinnedPath(item);
            var originalText = copyBtn.textContent;
            copyBtn.textContent = '‚úî';
            setTimeout(function() { copyBtn.textContent = originalText; }, 900);
          });
          var downloadBtn = document.createElement('button');
          downloadBtn.className = 'pinned-path-btn pinned-path-cta';
          downloadBtn.textContent = '‚Üì Download all';
          downloadBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            downloadPinnedPath(item);
            var originalText = downloadBtn.textContent;
            downloadBtn.textContent = '‚úî';
            setTimeout(function() { downloadBtn.textContent = originalText; }, 900);
          });
          rowActions.appendChild(copyBtn);
          rowActions.appendChild(downloadBtn);

          var rowLayout = document.createElement('div');
          rowLayout.className = 'pinned-path-row';
          var layoutLabel = document.createElement('span');
          layoutLabel.className = 'pinned-path-label';
          layoutLabel.textContent = 'Layout:';
          rowLayout.appendChild(layoutLabel);
          ['grid', 'line', 'stacked'].forEach(function(mode) {
            var btn = document.createElement('button');
            btn.className = 'pinned-path-btn' + (item.layout === mode ? ' active' : '');
            btn.textContent = mode === 'grid' ? 'As grid' : mode === 'line' ? 'In line' : 'Stacked';
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              item.layout = mode;
              item.expanded = true;
              updatePinnedUI();
            });
            rowLayout.appendChild(btn);
          });

          var rowSpacing = document.createElement('div');
          rowSpacing.className = 'pinned-path-row';
          var spacingLabel = document.createElement('span');
          spacingLabel.className = 'pinned-path-label';
          spacingLabel.textContent = 'Spacing:';
          rowSpacing.appendChild(spacingLabel);
          [
            { label: 'small', text: 'Small (1m)' },
            { label: 'medium', text: 'Medium (5m)' },
            { label: 'large', text: 'Large (10m)' },
            { label: 'huge', text: 'Huge (25m)' }
          ].forEach(function(opt) {
            var btn = document.createElement('button');
            btn.className = 'pinned-path-btn' + (item.spacing === getSpacingValue(opt.label) ? ' active' : '');
            btn.textContent = opt.text;
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              item.spacing = getSpacingValue(opt.label);
              item.expanded = true;
              updatePinnedUI();
            });
            rowSpacing.appendChild(btn);
          });

          var rowMode = document.createElement('div');
          rowMode.className = 'pinned-path-row';
          var modeLabel = document.createElement('span');
          modeLabel.className = 'pinned-path-label';
          modeLabel.textContent = 'Type:';
          rowMode.appendChild(modeLabel);
          ['Config', 'P3D', 'Both'].forEach(function(mode) {
            var btn = document.createElement('button');
            btn.className = 'pinned-path-btn' + (item.mode === mode ? ' active' : '');
            btn.textContent = mode;
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              item.mode = mode;
              item.expanded = true;
              updatePinnedUI();
            });
            rowMode.appendChild(btn);
          });

          panel.appendChild(rowActions);
          panel.appendChild(rowLayout);
          panel.appendChild(rowSpacing);
          panel.appendChild(rowMode);
          wrapper.appendChild(panel);
        }
        pinnedListEl.appendChild(wrapper);
      });

      if (pinnedItems.length > 0) {
        pinnedObjectsEl.classList.remove('is-empty');
        objectFocusEl.classList.add('has-pins');
      } else {
        pinnedObjectsEl.classList.add('is-empty');
        objectFocusEl.classList.remove('has-pins');
      }

      var hasPins = pinnedItems.length > 0;
      if (!hasPins) {
        pinnedBulkExpanded = false;
      }
      if (pinnedCopyAllEl) {
        pinnedCopyAllEl.classList.toggle('visible', hasPins);
      }

      if (pinnedCopyNamesEl) {
        pinnedCopyNamesEl.classList.toggle('visible', hasPins);
      }

      if (pinnedCopyLinkEl) {
        pinnedCopyLinkEl.classList.toggle('visible', hasPins);
      }

      if (pinnedCopyAllLayoutEl) {
        pinnedCopyAllLayoutEl.classList.toggle('visible', hasPins);
      }

      if (pinnedCopyAllLayoutRowEl) {
        pinnedCopyAllLayoutRowEl.classList.toggle('visible', hasPins);
      }

      if (pinnedBulkPanelEl) {
        pinnedBulkPanelEl.classList.toggle('visible', hasPins && pinnedBulkExpanded);
      }

      if (pinnedDownloadAllEl) {
        pinnedDownloadAllEl.classList.toggle('visible', hasPins);
      }

      if (pinnedClearAllEl) {
        pinnedClearAllEl.classList.toggle('visible', hasPins);
      }

      savePinnedItems();
      updateEmptyState();
    };

    var pinnedBulkLayout = 'line';
    var pinnedBulkSpacing = 5;
    var pinnedBulkExpanded = false;

    pinnedItems = loadPinnedItems();
    updatePinnedUI();

    var updatePinnedBulkButtons = function() {
      if (pinnedBulkLayoutButtons && pinnedBulkLayoutButtons.length) {
        pinnedBulkLayoutButtons.forEach(function(btn) {
          btn.classList.toggle('active', btn.getAttribute('data-layout') === pinnedBulkLayout);
        });
      }
      if (pinnedBulkSpacingButtons && pinnedBulkSpacingButtons.length) {
        pinnedBulkSpacingButtons.forEach(function(btn) {
          btn.classList.toggle('active', getSpacingValue(btn.getAttribute('data-spacing')) === pinnedBulkSpacing);
        });
      }
      if (pinnedCopyAllLayoutEl) {
        pinnedCopyAllLayoutEl.classList.toggle('active', pinnedBulkExpanded);
      }
    };

    if (pinnedBulkLayoutButtons && pinnedBulkLayoutButtons.length) {
      pinnedBulkLayoutButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          pinnedBulkLayout = btn.getAttribute('data-layout') || 'line';
          updatePinnedBulkButtons();
        });
      });
    }

    if (pinnedBulkSpacingButtons && pinnedBulkSpacingButtons.length) {
      pinnedBulkSpacingButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          pinnedBulkSpacing = getSpacingValue(btn.getAttribute('data-spacing'));
          updatePinnedBulkButtons();
        });
      });
    }

    updatePinnedBulkButtons();

    var buildEditorJsonArray = function(item) {
      var jsonText = buildEditorJson(
        item.editorJsonRaw,
        item.objName,
        item.modelType,
        item.p3dPath
      );
      try {
        var parsed = JSON.parse(jsonText);
        return Array.isArray(parsed) ? parsed : [parsed];
      } catch (err) {
        console.error('Invalid editor JSON for pinned item:', err);
        return [];
      }
    };

    var showObjectFocus = function($td, updateUrl) {
      if (!objectFocusEl || !$td || !$td.length) return;
      if (currentObjectRowEl) {
        currentObjectRowEl.classList.remove('object-selected');
      }
      if (objectFocusEl.classList.contains('collapsed')) {
        objectFocusEl.classList.remove('collapsed');
        updateCollapseButtonLabel();
        updateEmptyState();
        updateLayoutForSidebar();
      }
      objectFocusEl.classList.add('expanded');
      currentObjectRowEl = $td.closest('tr').get(0);
      if (currentObjectRowEl) {
        currentObjectRowEl.classList.add('object-selected');
      }
      setObjectFocusData({
        objName: $td.data('object') || '',
        imgPath: $td.data('image'),
        p3dPath: $td.data('p3d'),
        modelType: $td.data('modeltype'),
        category: $td.data('category'),
        inGame: $td.data('ingame'),
        consoleFlag: $td.data('console'),
        tags: $td.data('tags'),
        editorJsonRaw: $td.attr('data-editorjson')
      }, updateUrl);
    };

    var showMissingObject = function(objName) {
      if (!objectFocusEl) return;
      currentObjectName = objName;
      objectFocusNameEl.textContent = objName;
      objectFocusPathEl.textContent = 'No exact match found.';
      if (objectFocusMetaEl) {
        objectFocusMetaEl.innerHTML = '';
      }
      objectFocusImageEl.innerHTML =
        '<span class="object-focus__missing">No image available for this object.</span>';
      objectFocusLinkEl.style.display = 'none';
      objectFocusEl.classList.add('visible');
      updateEmptyState();
    };

    var focusByName = function(objName) {
      if (!objName) return;
      var normalized = objName.trim();
      if (!normalized) return;
      table.column(2).search('^' + escapeRegex(normalized), true, false).draw();
      table.one('draw', function() {
        var $cell = $tableEl.find('tbody .object-name-cell').filter(function() {
          var value = $(this).data('object');
          return value && String(value).toLowerCase() === normalized.toLowerCase();
        }).first();

        if ($cell.length) {
          showObjectFocus($cell, false);
          var rowEl = $cell.closest('tr').get(0);
          if (rowEl && rowEl.scrollIntoView) {
            rowEl.classList.add('flash');
            rowEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(function() { rowEl.classList.remove('flash'); }, 1200);
          }
        } else {
          showMissingObject(normalized);
        }
      });
    };

    if (objectFocusClearEl) {
      objectFocusClearEl.addEventListener('click', function() {
        table.column(2).search('').draw();
        hideFocusDetails();
        history.replaceState({}, '', buildObjectUrl(''));
      });
    }

    if (objectFocusCopyEl) {
      objectFocusCopyEl.addEventListener('click', function() {
        var link = buildObjectUrl(currentObjectName || objectFocusNameEl.textContent || '');
        navigator.clipboard.writeText(link);
        var original = objectFocusCopyEl.textContent;
        objectFocusCopyEl.textContent = 'Copied';
        setTimeout(function() { objectFocusCopyEl.textContent = original; }, 1200);
      });
    }

    if (objectFocusEditorEl) {
      objectFocusEditorEl.addEventListener('click', function() {
        if (!currentObjectData) return;
        var jsonText = buildEditorJson(
          currentObjectData.editorJsonRaw,
          currentObjectData.objName,
          currentObjectData.modelType,
          currentObjectData.p3dPath
        );
        navigator.clipboard.writeText(jsonText);
        var original = objectFocusEditorEl.textContent;
        objectFocusEditorEl.textContent = 'Copied';
        setTimeout(function() { objectFocusEditorEl.textContent = original; }, 1200);
      });
    }

    if (objectFocusNameCopyEl) {
      objectFocusNameCopyEl.addEventListener('click', function() {
        var nameText = currentObjectName || objectFocusNameEl.textContent || '';
        if (!nameText) return;
        navigator.clipboard.writeText(nameText);
        var original = objectFocusNameCopyEl.textContent;
        objectFocusNameCopyEl.textContent = 'Copied';
        setTimeout(function() { objectFocusNameCopyEl.textContent = original; }, 1200);
      });
    }

    if (objectFocusPinEl) {
      objectFocusPinEl.addEventListener('click', function() {
        if (!currentObjectData || !currentObjectData.objName) return;
        var exists = isPinned(currentObjectData.objName);
        if (exists) {
          pinnedItems = pinnedItems.filter(function(item) {
            return item.objName !== currentObjectData.objName;
          });
          updatePinnedUI();
          if (objectFocusPinEl) {
            objectFocusPinEl.textContent = 'üìå Pin';
          }
          return;
        }
        pinnedItems.push({
          objName: currentObjectData.objName,
          imgPath: currentObjectData.imgPath,
          p3dPath: currentObjectData.p3dPath,
          modelType: currentObjectData.modelType,
          editorJsonRaw: currentObjectData.editorJsonRaw,
          category: currentObjectData.category,
          inGame: currentObjectData.inGame,
          consoleFlag: currentObjectData.consoleFlag,
          tags: currentObjectData.tags
        });
        updatePinnedUI();
        hideFocusDetails();
      });
    }

    if (pinnedCopyNamesEl) {
      pinnedCopyNamesEl.addEventListener('click', function() {
        var entries = getPinnedEntries();
        if (!entries.length) return;
        var names = entries.map(function(item) { return item.objName; }).filter(Boolean);
        if (!names.length) return;
        navigator.clipboard.writeText(names.join('\n'));
        pinnedCopyNamesEl.textContent = '‚úî';
        setTimeout(function() { pinnedCopyNamesEl.textContent = 'üìã'; }, 900);
      });
    }

    if (pinnedCopyLinkEl) {
      pinnedCopyLinkEl.addEventListener('click', function() {
        var entries = getPinnedEntries();
        if (!entries.length) return;
        var names = entries.map(function(item) { return item.objName; }).filter(Boolean);
        if (!names.length) return;
        var link = buildPinnedUrl(names);
        navigator.clipboard.writeText(link);
        var original = pinnedCopyLinkEl.textContent;
        pinnedCopyLinkEl.textContent = 'Copied';
        setTimeout(function() { pinnedCopyLinkEl.textContent = original; }, 1200);
      });
    }

    if (objectFocusCollapseEl) {
      objectFocusCollapseEl.addEventListener('click', function() {
        if (!objectFocusEl) return;
        objectFocusEl.classList.toggle('collapsed');
        if (objectFocusEl.classList.contains('collapsed')) {
          objectFocusEl.classList.remove('expanded');
        } else {
          objectFocusEl.classList.add('expanded');
        }
        updateCollapseButtonLabel();
        updateEmptyState();
        updateLayoutForSidebar();
      });
    }

    if (pinnedCopyAllEl) {
      pinnedCopyAllEl.addEventListener('click', function() {
        var entries = getPinnedEntries();
        if (!entries.length) return;
        var combined = [];
        var cursor = 0;
        var spacingBase = 10;
        entries.forEach(function(item) {
          var objects = buildEditorJsonArray(item);
          objects.forEach(function(obj) {
            var scale = 1;
            if (obj && obj.Scale !== undefined && obj.Scale !== null) {
              var parsedScale = parseFloat(obj.Scale);
              if (!isNaN(parsedScale) && isFinite(parsedScale)) {
                scale = parsedScale;
              }
            }
            if (!obj.Position || obj.Position.length < 3) {
              obj.Position = [0, 0, 0];
            }
            obj.Position[0] = cursor;
            cursor += spacingBase * scale;
            combined.push(obj);
          });
        });
        if (!combined.length) return;
        navigator.clipboard.writeText(JSON.stringify(combined, null, 4));
        pinnedCopyAllEl.textContent = '‚úî';
        setTimeout(function() { pinnedCopyAllEl.textContent = 'üèóÔ∏è'; }, 900);
      });
    }

    if (pinnedCopyAllLayoutEl) {
      pinnedCopyAllLayoutEl.addEventListener('click', function() {
        pinnedBulkExpanded = !pinnedBulkExpanded;
        updatePinnedUI();
        updatePinnedBulkButtons();
      });
    }

    if (pinnedBulkCopyConfirmEl) {
      pinnedBulkCopyConfirmEl.addEventListener('click', function() {
        var includePaths = pinnedIncludePathsEl ? pinnedIncludePathsEl.checked : false;
        var entries = getPinnedObjectEntries(includePaths);
        if (!entries.length) return;
        var combined = [];
        entries.forEach(function(item, index) {
          var objects = buildEditorJsonArray(item);
          applyLayoutOffsets(objects, index, entries.length, pinnedBulkLayout, pinnedBulkSpacing);
          combined = combined.concat(objects);
        });
        if (!combined.length) return;
        navigator.clipboard.writeText(JSON.stringify(combined, null, 4));
        var originalText = pinnedBulkCopyConfirmEl.textContent;
        pinnedBulkCopyConfirmEl.textContent = '‚úî';
        setTimeout(function() { pinnedBulkCopyConfirmEl.textContent = originalText; }, 1200);
      });
    }

    if (pinnedClearAllEl) {
      pinnedClearAllEl.addEventListener('click', function() {
        if (!pinnedItems.length) return;
        pinnedItems = [];
        updatePinnedUI();
        if (objectFocusPinEl && currentObjectName) {
          objectFocusPinEl.textContent = 'üìå Pin';
        }
      });
    }

    var csvEscape = function(value) {
      if (value === null || value === undefined) return '';
      var str = String(value);
      if (str.indexOf('"') !== -1 || str.indexOf(',') !== -1 || str.indexOf('\n') !== -1 || str.indexOf('\r') !== -1) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    };
    var sanitizePathFolder = function(value) {
      if (!value) return 'unknown';
      return String(value)
        .replace(/[\\\/]+/g, '_')
        .replace(/[^a-zA-Z0-9._-]/g, '_')
        .slice(0, 80);
    };
    var buildEditorJsonArrayWithMode = function(item, mode) {
      if (!item) return [];
      var originalModelType = item.modelType;
      if (mode === 'Config') {
        item.modelType = 'Config';
        var configItems = buildEditorJsonArray(item);
        item.modelType = originalModelType;
        return configItems;
      }
      if (mode === 'P3D') {
        item.modelType = 'P3D';
        var p3dItems = buildEditorJsonArray(item);
        item.modelType = originalModelType;
        return p3dItems;
      }
      if (mode === 'Both') {
        item.modelType = 'Config';
        var configItems = buildEditorJsonArray(item);
        item.modelType = 'P3D';
        var p3dItems = buildEditorJsonArray(item);
        item.modelType = originalModelType;
        return configItems.concat(p3dItems);
      }
      return buildEditorJsonArray(item);
    };
    var applyLayoutOffsets = function(objects, index, count, layout, spacing) {
      if (!objects || !objects.length) return;
      var offsetX = 0;
      var offsetZ = 0;
      var offsetY = 0;
      if (layout === 'line') {
        offsetX = index * spacing;
      } else if (layout === 'grid') {
        var cols = Math.max(1, Math.ceil(Math.sqrt(count)));
        var col = index % cols;
        var row = Math.floor(index / cols);
        offsetX = col * spacing;
        offsetZ = row * spacing;
      } else if (layout === 'stacked') {
        offsetY = index * spacing;
      }
      objects.forEach(function(obj) {
        if (!obj.Position || obj.Position.length < 3) {
          obj.Position = [0, 0, 0];
        }
        obj.Position[0] += offsetX;
        obj.Position[1] += offsetY;
        obj.Position[2] += offsetZ;
      });
    };

    if (pinnedDownloadAllEl) {
      pinnedDownloadAllEl.addEventListener('click', function() {
        var entries = getPinnedEntries();
        if (!entries.length) return;
        if (typeof JSZip === 'undefined' || typeof saveAs === 'undefined') return;

        var zip = new JSZip();
        var csvRows = [];
        csvRows.push([
          'className',
          'inGameName',
          'category',
          'path',
          'console',
          'type',
          'tags',
          'image',
          'imageFound'
        ].join(','));

        var imagePromises = entries.map(function(item) {
          var imageFound = item.imgPath ? 'Yes' : 'No';
          csvRows.push([
            csvEscape(item.objName),
            csvEscape(item.inGame),
            csvEscape(item.category),
            csvEscape(item.p3dPath),
            csvEscape(item.consoleFlag === '‚úÖ' ? 'Yes' : item.consoleFlag === '‚ùå' ? 'No' : item.consoleFlag),
            csvEscape(item.modelType),
            csvEscape(item.tags),
            csvEscape(item.imgPath),
            csvEscape(imageFound)
          ].join(','));

          if (!item.imgPath) return Promise.resolve();
          return fetch('/' + item.imgPath)
            .then(function(response) {
              if (!response.ok) throw new Error('Image fetch failed');
              return response.blob();
            })
            .then(function(blob) {
              var name = item.objName ? (item.objName + '.png') : item.imgPath.split('/').pop();
              if (item.sourcePath) {
                zip.file('images/' + sanitizePathFolder(item.sourcePath) + '/' + name, blob);
              } else {
                zip.file('images/' + name, blob);
              }
            })
            .catch(function() {});
        });

        zip.file('objects.csv', csvRows.join('\n'));

        Promise.all(imagePromises).then(function() {
          return zip.generateAsync({ type: 'blob' });
        }).then(function(content) {
          saveAs(content, 'dayz_objects.zip');
        }).catch(function() {});
      });
    }

    var copyPinnedPath = function(pathItem) {
      if (!pathItem || !Array.isArray(pathItem.items) || !pathItem.items.length) return;
      var entries = pathItem.items;
      var combined = [];
      var spacing = pathItem.spacing || 5;
      var layout = pathItem.layout || 'line';
      var mode = pathItem.mode || 'P3D';
      entries.forEach(function(item, index) {
        var objects = buildEditorJsonArrayWithMode(item, mode);
        applyLayoutOffsets(objects, index, entries.length, layout, spacing);
        combined = combined.concat(objects);
      });
      if (!combined.length) return;
      navigator.clipboard.writeText(JSON.stringify(combined, null, 4));
    };

    var downloadPinnedPath = function(pathItem) {
      if (!pathItem || !Array.isArray(pathItem.items) || !pathItem.items.length) return;
      if (typeof JSZip === 'undefined' || typeof saveAs === 'undefined') return;
      var entries = pathItem.items;
      var zip = new JSZip();
      var csvRows = [];
      csvRows.push([
        'className',
        'inGameName',
        'category',
        'path',
        'console',
        'type',
        'tags',
        'image',
        'imageFound'
      ].join(','));

      var imagePromises = entries.map(function(item) {
        var imageFound = item.imgPath ? 'Yes' : 'No';
        csvRows.push([
          csvEscape(item.objName),
          csvEscape(item.inGame),
          csvEscape(item.category),
          csvEscape(item.p3dPath),
          csvEscape(item.consoleFlag === '‚úÖ' ? 'Yes' : item.consoleFlag === '‚ùå' ? 'No' : item.consoleFlag),
          csvEscape(item.modelType),
          csvEscape(item.tags),
          csvEscape(item.imgPath),
          csvEscape(imageFound)
        ].join(','));

        if (!item.imgPath) return Promise.resolve();
        return fetch('/' + item.imgPath)
          .then(function(response) {
            if (!response.ok) throw new Error('Image fetch failed');
            return response.blob();
          })
          .then(function(blob) {
            var name = item.objName ? (item.objName + '.png') : item.imgPath.split('/').pop();
            var folder = sanitizePathFolder(pathItem.p3dPath || pathItem.objName);
            zip.file('images/' + folder + '/' + name, blob);
          })
          .catch(function() {});
      });

      zip.file('objects.csv', csvRows.join('\n'));

      Promise.all(imagePromises).then(function() {
        return zip.generateAsync({ type: 'blob' });
      }).then(function(content) {
        var folder = sanitizePathFolder(pathItem.p3dPath || 'path');
        saveAs(content, folder + '_objects.zip');
      }).catch(function() {});
    };

    var parsePinnedParam = function(value) {
      if (!value) return [];
      return value.split('|').map(function(item) {
        try {
          return decodeURIComponent(item.replace(/\+/g, ' '));
        } catch (err) {
          return item.replace(/\+/g, ' ');
        }
      }).map(function(name) { return name.trim(); }).filter(Boolean);
    };

    var findObjectCellByName = function(objName) {
      if (!objName) return null;
      var normalized = objName.trim();
      if (!normalized) return null;
      var matchCell = $(table.rows().nodes()).find('.object-name-cell').filter(function() {
        var value = $(this).data('object');
        return value && String(value).toLowerCase() === normalized.toLowerCase();
      }).first();
      return matchCell.length ? matchCell : null;
    };

    var searchParams = new URLSearchParams(window.location.search);
    var pinnedParam = searchParams.get('pinned');
    var objectParam = searchParams.get('object');
    var appliedUrlState = false;

    var applyUrlState = function(sourceData) {
      if (appliedUrlState) return;
      appliedUrlState = true;

      if (pinnedParam) {
        var names = parsePinnedParam(pinnedParam);
        if (names.length) {
          pinnedItems = [];
          var seen = {};
          var data = Array.isArray(sourceData) ? sourceData : table.rows().data();
          names.forEach(function(name) {
            var key = name.toLowerCase();
            if (seen[key]) return;
            seen[key] = true;
            var match = null;
            for (var i = 0; i < data.length; i++) {
              var row = data[i];
              var objName = getObjectName(row);
              if (objName && objName.toLowerCase() === key) {
                match = row;
                break;
              }
            }
            var item = buildPinnedItemFromData(match);
            if (item && item.objName) {
              pinnedItems.push(item);
            }
          });
          updatePinnedUI();
          if (objectFocusEl) {
            objectFocusEl.classList.remove('collapsed');
            updateCollapseButtonLabel();
            updateEmptyState();
          }
        }
      }

      if (objectParam) {
        focusByName(objectParam);
      }
    };


    var populateCategories = function(sourceData) {
      var categories = [];
      if (Array.isArray(sourceData)) {
        sourceData.forEach(function(item) {
          var value = item && item.category ? String(item.category) : '';
          if (value && categories.indexOf(value) === -1) {
            categories.push(value);
          }
        });
      } else if (table) {
        table.column(4).data().each(function(value) {
          if (value && categories.indexOf(value) === -1) {
            categories.push(value);
          }
        });
      }
      categories.sort();
      var $select = $('#filterCategory');
      $select.find('option:not([value=""])').remove();
      categories.forEach(function(cat) {
        $select.append('<option value="' + cat + '">' + cat + '</option>');
      });
    };
    table.on('xhr.dt', function(e, settings, json) {
      populateCategories(json);
      applyUrlState(json);
    });

    $('#filterCategory').on('change', function() {
      table.column(4).search(this.value).draw();
    });

    $('#filterConsole').on('change', function() {
      table.column(6).search(this.value).draw();
    });

    var presetsCategoryValue = "Editor Preset";
    var presetsActive = false;
    var previousCategoryValue = "";

    var resetFilters = function() {
      if (!table) return;
      table.search('').columns().search('').draw();
      $('#filterCategory').val('').trigger('change');
      $('#filterConsole').val('').trigger('change');
      if (presetsActive) {
        presetsActive = false;
        previousCategoryValue = '';
        $('#togglePresets').removeClass('active').text('Show presets');
      }
      hideFocusDetails();
      if (objectFocusEl) {
        objectFocusEl.classList.add('visible', 'collapsed');
        updateCollapseButtonLabel();
        updateEmptyState();
      }
      var nextUrl = new URL(window.location);
      nextUrl.searchParams.delete('object');
      history.replaceState({}, '', nextUrl);
    };

    var togglePresets = function($btn) {
      if (!table) return;
      if (!presetsActive) {
        previousCategoryValue = $('#filterCategory').val();
        $('#filterCategory').val(presetsCategoryValue).trigger('change');
        presetsActive = true;
        $btn.addClass('active').text('Show all');
      } else {
        $('#filterCategory').val(previousCategoryValue).trigger('change');
        presetsActive = false;
        $btn.removeClass('active').text('Show presets');
      }
    };

    $(document).on('click', '#resetFilters', function() {
      resetFilters();
    });

    $(document).on('click', '#togglePresets', function() {
      togglePresets($(this));
    });

    var exportPanelEl = document.getElementById('exportPanel');
    var exportToggleEl = document.getElementById('exportToggle');

    var setExportPanelState = function(isOpen) {
      if (!exportPanelEl || !exportToggleEl) return;
      exportPanelEl.classList.toggle('is-open', isOpen);
      exportPanelEl.setAttribute('aria-hidden', String(!isOpen));
      exportToggleEl.setAttribute('aria-expanded', String(isOpen));
    };

    if (exportToggleEl) {
      exportToggleEl.addEventListener('click', function() {
        var isOpen = exportPanelEl && exportPanelEl.classList.contains('is-open');
        setExportPanelState(!isOpen);
      });
    }

    var getCurrentViewRows = function() {
      if (!table) return [];
      var rows = [];
      table.rows({ search: 'applied' }).every(function() {
        var rowEl = this.node();
        var cell = rowEl ? rowEl.querySelector('.object-name-cell') : null;
        if (!cell) return;
        rows.push({
          className: cell.getAttribute('data-object') || '',
          inGameName: cell.getAttribute('data-ingame') || '',
          category: cell.getAttribute('data-category') || '',
          path: cell.getAttribute('data-p3d') || '',
          console: cell.getAttribute('data-console') || '',
          type: cell.getAttribute('data-modeltype') || '',
          tags: cell.getAttribute('data-tags') || ''
        });
      });
      return rows;
    };

    var downloadTextFile = function(content, filename, mimeType) {
      var blob = new Blob([content], { type: mimeType || 'text/plain;charset=utf-8' });
      if (typeof saveAs !== 'undefined') {
        saveAs(blob, filename);
        return;
      }
      var link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(function() { URL.revokeObjectURL(link.href); }, 500);
    };

    var exportCurrentViewCsv = function() {
      var rows = getCurrentViewRows();
      if (!rows.length) return;
      var csvRows = [];
      csvRows.push([
        'className',
        'inGameName',
        'category',
        'path',
        'console',
        'type',
        'tags'
      ].join(','));
      rows.forEach(function(item) {
        csvRows.push([
          csvEscape(item.className),
          csvEscape(item.inGameName),
          csvEscape(item.category),
          csvEscape(item.path),
          csvEscape(item.console === '‚úÖ' ? 'Yes' : item.console === '‚ùå' ? 'No' : item.console),
          csvEscape(item.type),
          csvEscape(item.tags)
        ].join(','));
      });
      var csvContent = '\ufeff' + csvRows.join('\r\n');
      downloadTextFile(csvContent, 'dayz_objects_view.csv', 'text/csv;charset=utf-8');
    };

    var exportCurrentViewXlsx = function() {
      if (typeof XLSX === 'undefined') return;
      var rows = getCurrentViewRows();
      if (!rows.length) return;
      var data = rows.map(function(item) {
        return {
          className: item.className,
          inGameName: item.inGameName,
          category: item.category,
          path: item.path,
          console: item.console === '‚úÖ' ? 'Yes' : item.console === '‚ùå' ? 'No' : item.console,
          type: item.type,
          tags: item.tags
        };
      });
      var worksheet = XLSX.utils.json_to_sheet(data);
      var workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Objects');
      var arrayBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      var blob = new Blob([arrayBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      if (typeof saveAs !== 'undefined') {
        saveAs(blob, 'dayz_objects_view.xlsx');
      }
    };

    var exportCurrentViewJson = function() {
      var rows = getCurrentViewRows();
      if (!rows.length) return;
      downloadTextFile(JSON.stringify(rows, null, 2), 'dayz_objects_view.json', 'application/json;charset=utf-8');
    };

    $(document).on('click', '#exportCsv', function() {
      exportCurrentViewCsv();
    });

    $(document).on('click', '#exportXlsx', function() {
      exportCurrentViewXlsx();
    });

    $(document).on('click', '#exportJson', function() {
      exportCurrentViewJson();
    });

    $('#dayzObjects tbody')
      .on('mouseenter', '.object-name-cell', function(e) {
        if (isMobileView) return;
        var imgPath = $(this).data('image');
        if (!imgPath) return;

        $('body').append(
          '<div id="imgPreview" class="preview-card">' +
            '<img src="/' + imgPath + '" alt="Object preview">' +
          '</div>'
        );
        $('#imgPreview').css({ top: e.pageY + 10, left: e.pageX + 10 });
      })
      .on('mousemove', '.object-name-cell', function(e) {
        if (isMobileView) return;
        $('#imgPreview').css({ top: e.pageY + 10, left: e.pageX + 10 });
      })
      .on('mouseleave', '.object-name-cell', function() {
        if (isMobileView) return;
        $('#imgPreview').remove();
      });

    var closeOtherRowDetails = function($keepRow) {
      if (!table) return;
      $(table.rows().nodes()).each(function() {
        var $row = $(this);
        if ($keepRow && $row.is($keepRow)) return;
        var row = table.row($row);
        if (row && row.child && row.child.isShown()) {
          row.child.hide();
          $row.removeClass('parent');
        }
      });
    };

    $('#dayzObjects tbody').on('click', '.object-name-cell', function(e) {
      if ($(e.target).hasClass('copy-btn')) return;
      e.stopPropagation();
      if (table) {
        var $row = $(this).closest('tr');
        var row = table.row($row);
        if (row && row.child) {
          if (isMobileView) {
            var isOpen = row.child.isShown();
            closeOtherRowDetails($row);
            if (isOpen) {
              row.child.hide();
              $row.removeClass('parent');
              return;
            }
            row.child(buildRowDetailsHtml($(this)), 'child').show();
            $row.addClass('parent');
            return;
          }
          if (row.child.isShown()) {
            row.child.hide();
            $row.removeClass('parent');
          }
        }
      }
      var objName = $(this).data('object');
      if (objectFocusEl && objectFocusEl.classList.contains('visible') && currentObjectName === objName) {
        hideFocusDetails();
        return;
      }
      showObjectFocus($(this), false);
    });

    $('#dayzObjects tbody').on('click', '.copy-btn:not(.editor-copy-btn):not(.pin-btn):not(.path-link-btn)', function(e) {
      e.stopPropagation();
      var text = $(this).closest('td').data('object');
      navigator.clipboard.writeText(text);
      var $btn = $(this);
      $btn.text('‚úî');
      setTimeout(function() { $btn.text('üìã'); }, 1000);
    });

    $('#dayzObjects tbody').on('click', '.pin-btn', function(e) {
      e.stopPropagation();
      var $td = $(this).closest('td');
      var item = buildPinnedItemFromCell($td);
      var $btn = $(this);
      var original = $btn.text();
      if (isPinned(item.objName)) {
        removePinnedItemByName(item.objName);
      } else {
        addPinnedItem(item);
      }
      $btn.text('‚úî');
      setTimeout(function() { $btn.text(original); }, 900);
    });

    $('#dayzObjects tbody').on('click', '.path-pin-btn', function(e) {
      e.stopPropagation();
      var $cell = $(this).closest('td');
      var $row = $cell.closest('tr');
      var $nameCell = $row.find('.object-name-cell');
      var pathValue = $nameCell.data('p3d') || $cell.text().trim();
      if (!pathValue) return;
      var rows = [];
      $(table.rows().nodes()).each(function() {
        var cell = this.querySelector('.object-name-cell');
        if (!cell) return;
        if (cell.getAttribute('data-p3d') === pathValue) {
          rows.push(this);
        }
      });
      addPinnedPathItem(pathValue, rows);
      var $btn = $(this);
      var original = $btn.text();
      $btn.text('‚úî');
      setTimeout(function() { $btn.text(original); }, 900);
    });

    $('#dayzObjects tbody').on('click', '.path-link-btn', function(e) {
      e.stopPropagation();
      var $cell = $(this).closest('td');
      var $row = $cell.closest('tr');
      var $nameCell = $row.find('.object-name-cell');
      var pathValue = $nameCell.data('p3d') || $cell.text().trim();
      if (!pathValue) return;
      var rows = [];
      $(table.rows().nodes()).each(function() {
        var cell = this.querySelector('.object-name-cell');
        if (!cell) return;
        if (cell.getAttribute('data-p3d') === pathValue) {
          rows.push(this);
        }
      });
      var names = rows.map(function(rowEl) {
        var cell = rowEl.querySelector('.object-name-cell');
        return cell ? cell.getAttribute('data-object') : null;
      }).filter(Boolean);
      if (!names.length) return;
      navigator.clipboard.writeText(buildPinnedUrl(names));
      var $btn = $(this);
      var original = $btn.text();
      $btn.text('‚úî');
      setTimeout(function() { $btn.text(original); }, 900);
    });

    $('#dayzObjects tbody').on('click', '.row-detail__action', function(e) {
      e.stopPropagation();
      var $action = $(this);
      var action = $action.data('action');
      var $detail = $action.closest('.row-detail');
      var objName = $detail.data('object');
      var $row = $detail.closest('tr').prev();
      var $cell = $row.find('.object-name-cell');
      if (!$cell.length || !objName) return;

      if (action === 'close') {
        if (table) {
          var row = table.row($row);
          if (row && row.child && row.child.isShown()) {
            row.child.hide();
            $row.removeClass('parent');
          }
        }
        return;
      }

      if (action === 'pin') {
        var item = buildPinnedItemFromCell($cell);
        if (!item || !item.objName) return;
        if (isPinned(item.objName)) {
          removePinnedItemByName(item.objName);
        } else {
          addPinnedItem(item);
        }
        $action.text('‚úî');
        setTimeout(function() { $action.text('üìå Pin'); }, 900);
        return;
      }

      if (action === 'name') {
        navigator.clipboard.writeText(objName);
        $action.text('‚úî');
        setTimeout(function() { $action.text('üìã Copy name'); }, 900);
        return;
      }

      if (action === 'link') {
        navigator.clipboard.writeText(buildObjectUrl(objName));
        $action.text('‚úî');
        setTimeout(function() { $action.text('üîó Copy link'); }, 900);
        return;
      }

      if (action === 'editor') {
        var jsonText = buildEditorJson(
          $cell.attr('data-editorjson'),
          $cell.data('object'),
          $cell.data('modeltype'),
          $cell.data('p3d')
        );
        navigator.clipboard.writeText(jsonText);
        $action.text('‚úî');
        setTimeout(function() { $action.text('üèóÔ∏è Copy to Editor'); }, 900);
        return;
      }
    });

    $('#dayzObjects tbody').on('click', '.editor-copy-btn', function(e) {
      e.stopPropagation();
      var $td = $(this).closest('td');

      var predefined = $td.attr('data-editorjson');
      var jsonText = null;

      if (predefined && predefined.trim() !== "") {
        try {
          var parsed = JSON.parse(predefined); 
          jsonText = JSON.stringify(parsed, null, 4);
        } catch (err) {
          console.error("Invalid editorJson for row:", err);
        }
      }

      if (!jsonText) {
        var objName   = $td.data('object');
        var modelType = $td.data('modeltype');
        var path      = $td.data('p3d');

        var typeValue = (modelType === "Config")
          ? objName
          : path.replace(/\//g, "\\") + "\\" + objName;

        var json = [{
          Type: typeValue,
          DisplayName: "",
          Position: [0, 0, 0],
          Orientation: [0, 0, 0],
          Scale: 1.0,
          AttachmentMap: {},
          Model: "",
          Flags: 30,
          m_LowBits: 0,
          m_HighBits: 0
        }];

        jsonText = JSON.stringify(json, null, 4);
      }

      navigator.clipboard.writeText(jsonText);

      var $btn = $(this);
      $btn.text('‚úî');
      setTimeout(function() { $btn.text('üèóÔ∏è'); }, 1000);
    });
  });
</script>

{{ end }}
